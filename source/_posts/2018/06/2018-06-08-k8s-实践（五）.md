---
title: k8s-实践（五）
tags: [k8s, Docker]
img: https://www.holddie.com/img/20200105160533.jpg
date: 2018-06-08 14:42:17
categories: k8s
---

从我学会奔跑那一刻起，我就开始不停地向前奔跑，因为我不敢回头。怕回头看见的，是你眼角的失望。——盖世积木



### 发布一个简单的APP

查看kubectl版本

```shell
$ kubectl version
Client Version: version.Info{Major:"1", Minor:"9", GitVersion:"v1.9.0", GitCommit:"925c127ec6b946659ad0fd596fa959be43f0cc05", GitTreeState:"clean", BuildDate:"2017-12-15T21:07:38Z", GoVersion:"go1.9.2", Compiler:"gc", Platform:"windows/amd64"}
Server Version: version.Info{Major:"1", Minor:"10", GitVersion:"v1.10.0", GitCommit:"fc32d2f3698e36b93322a3465f63a14e9f0eaead", GitTreeState:"clean", BuildDate:"2018-03-26T16:44:10Z", GoVersion:"go1.9.3", Compiler:"gc", Platform:"linux/amd64"}
```

查看nodes节点信息

```shell
$ kubectl get nodes
```

创建一个Deployment

```shell
$ kubectl run kubernetes-bootcamp --image=gcr.io/google-samples/kubernetes-bootcamp:v1 --port=8080
```

查看deployments

```shell
$ kubectl get deployments
```

使用代理，暴露服务

```shell
$ kubectl proxy
```

另起一个terminal，测试

```shell
$ curl http://localhost:8001/version
```

查看服务运行在那个pod上

```shell
$ export POD_NAME=$(kubectl get pods -o go-template --template '{{range .items}}{{.metadata.name}}{{"\n"}}{{end}}')
$ echo Name of the Pod: $POD_NAME
```

产看对应代理信息，固定写法

```shell
$ curl http://localhost:8001/api/v1/namespaces/default/pods/$POD_NAME/proxy/
```



### kubectl 进阶

其中会常用的到一些基础命令：

```shell
kubectl get - 列出资源

kubectl describe - 显示资源的详细信息

kubectl logs - 打印pod中的容器日志

kubectl exec - pod中容器内部执行命令
```

#### 获取pod信息

```shell
$ kubectl get pods
```

查看pod内部，容器以及镜像详情

```shell
$ kubectl describe pods
Name:           kubernetes-bootcamp-5c69669756-hjq9l
Namespace:      default
Node:           minikube/172.17.0.181
Start Time:     Fri, 08 Jun 2018 09:46:42 +0000
Labels:         pod-template-hash=1725225312
                run=kubernetes-bootcamp
Annotations:    <none>
Status:         Running
IP:             172.18.0.2
Controlled By:  ReplicaSet/kubernetes-bootcamp-5c69669756
Containers:
  kubernetes-bootcamp:
    Container ID:   docker://6d5d294d873fcc33ad4a7e3cc7dbec742941ecc8e9c9ac279211c43fdec4e90f
    Image:          gcr.io/google-samples/kubernetes-bootcamp:v1
    Image ID:       docker-pullable://gcr.io/google-samples/kubernetes-bootcamp@sha256:0d6b8ee63bb57c5f5b6156f446b3bc3b3c143d233037f3a2f00e279c8fcc64af
    Port:           8080/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Fri, 08 Jun 2018 09:46:43 +0000
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-mzrjp (ro)
Conditions:
  Type           Status
  Initialized    True
  Ready          True
  PodScheduled   True
Volumes:
  default-token-mzrjp:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  default-token-mzrjp
    Optional:    false
QoS Class:       BestEffort
Node-Selectors:  <none>
Tolerations:     node.kubernetes.io/not-ready:NoExecute for 300s
                 node.kubernetes.io/unreachable:NoExecute for 300s
Events:
  Type     Reason                 Age              From               Message
  ----     ------                 ----             ----               -------
  Warning  FailedScheduling       3m (x4 over 3m)  default-scheduler  0/1 nodes are available: 1 node(s) were not ready.
  Normal   Scheduled              3m               default-scheduler  Successfully assigned kubernetes-bootcamp-5c69669756-hjq9l to minikube
  Normal   SuccessfulMountVolume  3m               kubelet, minikube  MountVolume.SetUp succeeded for volume "default-token-mzrjp"
  Normal   Pulled                 3m               kubelet, minikube  Container image"gcr.io/google-samples/kubernetes-bootcamp:v1" already present on machine
  Normal   Created                3m               kubelet, minikube  Created container
  Normal   Started                3m               kubelet, minikube  Started container
```

其中我们可以看到，IP地址，占用端口，以及与pod同声明周期相关的时间列表



#### 容器内部代理

```shell
$ kubectl proxy
```

同理获取pod信息

```shell
$ export POD_NAME=$(kubectl get pods -o go-template --template '{{range .items}}{{.metadata.name}}{{"\n"}}{{end}}')

$ echo Name of the Pod: $POD_NAME
```

同理查看代理信息

```shell
$ curl http://localhost:8001/api/v1/namespaces/default/pods/$POD_NAME/proxy/
```

获取执行日志

```shell
$ kubectl log $POD_NAME
```

在pod的内部我们不需要声明容器的名称，因为在pod中仅仅只会有一个容器



#### 容器内部执行命令

获取容器内部环境变量

```shell
$ kubectl exec $POD_NAME env
```

进入容器内部

```shell
$ kubectl exec -it $POD_NAME bash
```

进行linux基本操作

```shell
$ cat server.js
```

退出容器

```shell
$ exit
```



### k8s  Service 暴露应用

#### Service 要点

- Service 协调同一套服务对应不同 pod之 间的变化
- 定义了 Pod 的逻辑分组和一种访问策略
- 优先使用 `yaml` 或 `JSON` 定义 Service
- Service 四种类型：
  - *ClusterIP*（默认） - 在集群中内部IP上暴露服务。此类型使Service只能从群集中访问。
  - *NodePort* - 通过每个 Node 上的 IP 和静态端口（NodePort）暴露服务。NodePort 服务会路由到 ClusterIP 服务，这个 ClusterIP 服务会自动创建。通过请求 `<NodeIP>:<NodePort>`，可以从集群的外部访问一个 NodePort 服务。
  - *LoadBalancer* - 使用云提供商的负载均衡器（如果支持），可以向外部暴露服务。外部的负载均衡器可以路由到 NodePort 服务和 ClusterIP 服务。
  - *ExternalName* - 通过返回 `CNAME` 和它的值，可以将服务映射到 `externalName` 字段的内容，没有任何类型代理被创建。这种类型需要v1.7版本或更高版本`kube-dnsc`才支持。
- Service 使用 `label selectors` 来匹配一组 Pod，允许k8s中的对象进行逻辑运算，label 以 key/value 附加到对象上，Label可以在创建时或以后附加到对象上，可以随时修改。 
  - 指定用于开发，测试和生产的对象
  - 嵌入版本Label
  - 使用Label分类对象
- 可以使用 `--exposekubectl` 创建 Deployment 的同时创建 Service。



#### 暴露服务

查看pod

```shell
$ kubectl get pods
```

查看service

```shell
$ kubectl get service
NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP   2m
```

暴露端口，创建服务

```shell
$ kubectl expose deployment/kubernetes-bootcamp --type="NodePort" --port 8080
```

查看service

```shell
$ kubectl get service
NAME                  TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE
kubernetes            ClusterIP   10.96.0.1      <none>        443/TCP          6m
kubernetes-bootcamp   NodePort    10.97.74.179   <none>        8080:30357/TCP   45s
```

查看Service详细描述

```shell
$ kubectl describe services/kubernetes-bootcamp
Name:                     kubernetes-bootcamp
Namespace:                default
Labels:                   run=kubernetes-bootcamp
Annotations:              <none>
Selector:                 run=kubernetes-bootcamp
Type:                     NodePort
IP:                       10.97.74.179
Port:                     <unset>  8080/TCP
TargetPort:               8080/TCP
NodePort:                 <unset>  30357/TCP
Endpoints:                172.18.0.4:8080
Session Affinity:         None
External Traffic Policy:  Cluster
Events:                   <none>
```

设置一个变量定义端口

```shell
$ export NODE_PORT=$(kubectl get services/kubernetes-bootcamp -o go-template='{{(index .spec.ports 0).nodePort}}')

$ echo NODE_PORT=$NODE_PORT
NODE_PORT=30357
```

在外部环境测试

```shell
$ curl $(minikube ip):$NODE_PORT
Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-5c69669756-jclk7 | v=1
```

至此，使用**Service**暴露服务端口，基本OK。



#### 使用标签

**Deployment** 默认会给我自动创建标签，查看标签

```shell
$ kubectl describe deployment
Name:                   kubernetes-bootcamp
Namespace:              default
CreationTimestamp:      Fri, 08 Jun 2018 10:22:00 +0000
Labels:                 run=kubernetes-bootcamp
Annotations:            deployment.kubernetes.io/revision=1
Selector:               run=kubernetes-bootcamp
Replicas:               1 desired | 1 updated | 1 total | 1 available | 0 unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  1 max unavailable, 1 max surge
Pod Template:
  Labels:  run=kubernetes-bootcamp
  Containers:
   kubernetes-bootcamp:
    Image:        gcr.io/google-samples/kubernetes-bootcamp:v1
    Port:         8080/TCP
    Host Port:    0/TCP
    Environment:  <none>
    Mounts:       <none>
  Volumes:        <none>
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    True    NewReplicaSetAvailable
OldReplicaSets:  <none>
NewReplicaSet:   kubernetes-bootcamp-5c69669756 (1/1 replicas created)
Events:
  Type    Reason             Age   From                   Message
  ----    ------             ----  ----                   -------
  Normal  ScalingReplicaSet  18m   deployment-controller  Scaled up replica set kubernetes-bootcamp-5c69669756 to 1
```

使用标签查询 **pods**

```shell
$ kubectl get pods -l run=kubernetes-bootcamp
NAME                                   READY     STATUS    RESTARTS   AGE
kubernetes-bootcamp-5c69669756-jclk7   1/1       Running   0          19m
```

同理使用标签查询 **service**

```shell
$ kubectl get services -l run=kubernetes-bootcamp
NAME                  TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE
kubernetes-bootcamp   NodePort   10.97.74.179   <none>        8080:30357/TCP   16m
```

设置变量 **POD_NAME**

```shell
$ export POD_NAME=$(kubectl get pods -o go-template --template '{{range .items}}{{.metadata.name}}{{"\n"}}{{end}}')
$ echo Name of the Pod: $POD_NAME
```

添加标签

```shell
$ kubectl label pod $POD_NAME app=v1
```

继续查看标签

```shell
$ kubectl describe pods $POD_NAME
Name:           kubernetes-bootcamp-5c69669756-jclk7
Namespace:      default
Node:           minikube/172.17.0.228
Start Time:     Fri, 08 Jun 2018 10:22:07 +0000
Labels:         app=v1
                pod-template-hash=1725225312
                run=kubernetes-bootcamp
Annotations:    <none>
Status:         Running
IP:             172.18.0.4
Controlled By:  ReplicaSet/kubernetes-bootcamp-5c69669756
Containers:
  kubernetes-bootcamp:
    Container ID:   docker://72031c48ac3c121fb818d6ffc9a3aa5d949b5de5e63f1928f0482e24cea39602
    Image:          gcr.io/google-samples/kubernetes-bootcamp:v1
    Image ID:       docker-pullable://gcr.io/google-samples/kubernetes-bootcamp@sha256:0d6b8ee63bb57c5f5b6156f446b3bc3b3c143d233037f3a2f00e279c8fcc64af
    Port:           8080/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Fri, 08 Jun 2018 10:22:10 +0000
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-9gqr5 (ro)
Conditions:
  Type           Status
  Initialized    True
  Ready          True
  PodScheduled   True
Volumes:
  default-token-9gqr5:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  default-token-9gqr5
    Optional:    false
QoS Class:       BestEffort
Node-Selectors:  <none>
Tolerations:     node.kubernetes.io/not-ready:NoExecute for 300s
                 node.kubernetes.io/unreachable:NoExecute for 300s
Events:
  Type     Reason                 Age                From               Message
  ----     ------                 ----               ----               -------
  Warning  FailedScheduling       25m (x4 over 25m)  default-scheduler  0/1 nodes areavailable: 1 node(s) were not ready.
  Normal   Scheduled              25m                default-scheduler  Successfully assigned kubernetes-bootcamp-5c69669756-jclk7 to minikube
  Normal   SuccessfulMountVolume  25m                kubelet, minikube  MountVolume.SetUp succeeded for volume "default-token-9gqr5"
  Normal   Pulled                 25m                kubelet, minikube  Container image "gcr.io/google-samples/kubernetes-bootcamp:v1" already present on machine
  Normal   Created                25m                kubelet, minikube  Created container
  Normal   Started                25m                kubelet, minikube  Started container
```

使用新创建的 **lable** 查询 **pods** 

```shell
$ kubectl get pods -l app=v1
NAME                                   READY     STATUS    RESTARTS   AGE
kubernetes-bootcamp-5c69669756-jclk7   1/1       Running   0          27m
```

**删除Service**

同样可以使用 **label** 删除 **service**

```shell
$ kubectl delete service -l run=kubernetes-bootcamp
service "kubernetes-bootcamp" deleted
```

查询 **Services**

```shell
$ kubectl get services
```

确保服务删除

```shell
$ curl $(minikube ip):$NODE_PORT
```

访问服务内部

```shell
$ kubectl exec -it $POD_NAME curl localhost:8080
Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-5c69669756-jclk7 | v=1
```



### 应用伸缩

#### 伸缩要点

- 通过 **Deployment**  更改副本数可以实现 **伸缩**。

查看 Deployments 

```shell
$ kubectl get deployments
NAME                  DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
kubernetes-bootcamp   1         1         1            1           8m

# DESIRED：配置副本数量
# CURRENT：当前运行的副本数
# UP-TO-DATE：已更新以匹配所需（配置）状态的副本数量
# AVAILABLE：实际上有多少副本可供用户使用
```

动态扩容

```shell
$ kubectl scale deployments/kubernetes-bootcamp --replicas=4
deployment.extensions "kubernetes-bootcamp" scaled
```

查看 `pods `

```shell
$ kubectl get pods -o wide
NAME                                   READY     STATUS    RESTARTS   AGE       IP       NODE
kubernetes-bootcamp-5c69669756-2rjn4   1/1       Running   0          55s       172.18.0.5   minikube
kubernetes-bootcamp-5c69669756-czxqh   1/1       Running   0          1m        172.18.0.2   minikube
kubernetes-bootcamp-5c69669756-fb7gq   1/1       Running   0          55s       172.18.0.6   minikube
kubernetes-bootcamp-5c69669756-xxkv6   1/1       Running   0          55s       172.18.0.7   minikube
```

每个Pod拥有不同的IP地址，此时查看日志

```shell
$ kubectl describe deployments/kubernetes-bootcamp
Name:                   kubernetes-bootcamp
Namespace:              default
CreationTimestamp:      Fri, 08 Jun 2018 11:28:20 +0000
Labels:                 run=kubernetes-bootcamp
Annotations:            deployment.kubernetes.io/revision=1
Selector:               run=kubernetes-bootcamp
Replicas:               4 desired | 4 updated | 4 total | 4 available | 0 unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  1 max unavailable, 1 max surge
Pod Template:
  Labels:  run=kubernetes-bootcamp
  Containers:
   kubernetes-bootcamp:
    Image:        gcr.io/google-samples/kubernetes-bootcamp:v1
    Port:         8080/TCP
    Host Port:    0/TCP
    Environment:  <none>
    Mounts:       <none>
  Volumes:        <none>
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    True    NewReplicaSetAvailable
OldReplicaSets:  <none>
NewReplicaSet:   kubernetes-bootcamp-5c69669756 (4/4 replicas created)
Events:
  Type    Reason             Age   From                   Message
  ----    ------             ----  ----                   -------
  Normal  ScalingReplicaSet  33s   deployment-controller  Scaled up replica set kubernetes-bootcamp-5c69669756 to 1
  Normal  ScalingReplicaSet  27s   deployment-controller  Scaled up replica set kubernetes-bootcamp-5c69669756 to 4
```

此时，查看**services**

```shell
$ kubectl describe services/kubernetes-bootcamp
Name:                     kubernetes-bootcamp
Namespace:                default
Labels:                   run=kubernetes-bootcamp
Annotations:              <none>
Selector:                 run=kubernetes-bootcamp
Type:                     NodePort
IP:                       10.104.178.204
Port:                     <unset>  8080/TCP
TargetPort:               8080/TCP
NodePort:                 <unset>  31147/TCP
Endpoints:                172.18.0.2:8080,172.18.0.3:8080,172.18.0.4:8080 + 1 more...
Session Affinity:         None
External Traffic Policy:  Cluster
Events:                   <none>
```

标记外部端口

```shell
$ export NODE_PORT=$(kubectl get services/kubernetes-bootcamp -o go-template='{{(index .spec.ports 0).nodePort}}')
$ echo NODE_PORT=$NODE_PORT
```

外部请求

```shell
curl $(minikube ip):$NODE_PORT
```

更新副本数为 2

```shell
$ kubectl scale deployments/kubernetes-bootcamp --replicas=2
deployment.extensions "kubernetes-bootcamp" scaled
```

重新获得 **pod**

```shell
$ kubectl get pods -o wide
NAME                                   READY     STATUS    RESTARTS   AGE       IP       NODE
kubernetes-bootcamp-5c69669756-cnt8f   1/1       Running   0          8m        172.18.0.4   minikube
kubernetes-bootcamp-5c69669756-wjhcp   1/1       Running   0          8m        172.18.0.2   minikube
```



### 滚动更新

#### 滚动要点

- 与引用伸缩相似，滚动更新是实现流量负载均衡方式
- 滚动更新场景：
  - 将应用从一个环境升级到另一个环境
  - 回滚到之前的版本
  - 持续集成和持续交付应用的零停机

#### 更新APP版本

查看**deployments**

```shell
$ kubectl get deployments
NAME                  DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
kubernetes-bootcamp   4         4         4            4           2m
```

获取 **Pod** 节点

```shell
$ kubectl get pods
NAME                                   READY     STATUS    RESTARTS   AGE
kubernetes-bootcamp-5c69669756-268nt   1/1       Running   0          3m
kubernetes-bootcamp-5c69669756-6v7g7   1/1       Running   0          3m
kubernetes-bootcamp-5c69669756-dnlsd   1/1       Running   0          3m
kubernetes-bootcamp-5c69669756-wxqp6   1/1       Running   0          3m
```

使用 describe 查看 **Pod** 版本

```shell
$ kubectl describe pods
Name:           kubernetes-bootcamp-5c69669756-268nt
Namespace:      default
Node:           minikube/172.17.0.141
Start Time:     Fri, 08 Jun 2018 11:54:37 +0000
Labels:         pod-template-hash=1725225312
                run=kubernetes-bootcamp
Annotations:    <none>
Status:         Running
IP:             172.18.0.4
Controlled By:  ReplicaSet/kubernetes-bootcamp-5c69669756
Containers:
  kubernetes-bootcamp:
    Container ID:   docker://f347d70497e98b12050700f065c3b446b1e6080f5183027015d5f75af154ce1d
    Image:          gcr.io/google-samples/kubernetes-bootcamp:v1
    Image ID:       docker-pullable://gcr.io/google-samples/kubernetes-bootcamp@sha256:0d6b8ee63bb57c5f5b6156f446b3bc3b3c143d233037f3a2f00e279c8fcc64af
    Port:           8080/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Fri, 08 Jun 2018 11:54:40 +0000
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-pjfqj (ro)
Conditions:
  Type           Status
  Initialized    True
  Ready          True
  PodScheduled   True
Volumes:
  default-token-pjfqj:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  default-token-pjfqj
    Optional:    false
QoS Class:       BestEffort
Node-Selectors:  <none>
Tolerations:     node.kubernetes.io/not-ready:NoExecute for 300s
                 node.kubernetes.io/unreachable:NoExecute for 300s
Events:
  Type     Reason                 Age              From               Message
  ----     ------                 ----             ----               -------
  Warning  FailedScheduling       4m (x3 over 4m)  default-scheduler  0/1 nodes are available: 1 node(s) were not ready.
  Normal   Scheduled              4m               default-scheduler  Successfully assigned kubernetes-bootcamp-5c69669756-268nt to minikube
  Normal   SuccessfulMountVolume  4m               kubelet, minikube  MountVolume.SetUp succeeded for volume "default-token-pjfqj"
  Normal   Pulled                 4m               kubelet, minikube  Container image"gcr.io/google-samples/kubernetes-bootcamp:v1" already present on machine
  Normal   Created                4m               kubelet, minikube  Created container
  Normal   Started                4m               kubelet, minikube  Started container


Name:           kubernetes-bootcamp-5c69669756-6v7g7
Namespace:      default
Node:           minikube/172.17.0.141
Start Time:     Fri, 08 Jun 2018 11:54:37 +0000
Labels:         pod-template-hash=1725225312
                run=kubernetes-bootcamp
Annotations:    <none>
Status:         Running
IP:             172.18.0.3
Controlled By:  ReplicaSet/kubernetes-bootcamp-5c69669756
Containers:
  kubernetes-bootcamp:
    Container ID:   docker://ac6c1b7d1a5a4734d29dd9895126b96d39f5a553ba870e70028a7d2de0587347
    Image:          gcr.io/google-samples/kubernetes-bootcamp:v1
    Image ID:       docker-pullable://gcr.io/google-samples/kubernetes-bootcamp@sha256:0d6b8ee63bb57c5f5b6156f446b3bc3b3c143d233037f3a2f00e279c8fcc64af
    Port:           8080/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Fri, 08 Jun 2018 11:54:40 +0000
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-pjfqj (ro)
Conditions:
  Type           Status
  Initialized    True
  Ready          True
  PodScheduled   True
Volumes:
  default-token-pjfqj:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  default-token-pjfqj
    Optional:    false
QoS Class:       BestEffort
Node-Selectors:  <none>
Tolerations:     node.kubernetes.io/not-ready:NoExecute for 300s
                 node.kubernetes.io/unreachable:NoExecute for 300s
Events:
  Type     Reason                 Age              From               Message
  ----     ------                 ----             ----               -------
  Warning  FailedScheduling       4m (x3 over 4m)  default-scheduler  0/1 nodes are available: 1 node(s) were not ready.
  Normal   Scheduled              4m               default-scheduler  Successfully assigned kubernetes-bootcamp-5c69669756-6v7g7 to minikube
  Normal   SuccessfulMountVolume  4m               kubelet, minikube  MountVolume.SetUp succeeded for volume "default-token-pjfqj"
  Normal   Pulled                 4m               kubelet, minikube  Container image"gcr.io/google-samples/kubernetes-bootcamp:v1" already present on machine
  Normal   Created                4m               kubelet, minikube  Created container
  Normal   Started                4m               kubelet, minikube  Started container


Name:           kubernetes-bootcamp-5c69669756-dnlsd
Namespace:      default
Node:           minikube/172.17.0.141
Start Time:     Fri, 08 Jun 2018 11:54:37 +0000
Labels:         pod-template-hash=1725225312
                run=kubernetes-bootcamp
Annotations:    <none>
Status:         Running
IP:             172.18.0.6
Controlled By:  ReplicaSet/kubernetes-bootcamp-5c69669756
Containers:
  kubernetes-bootcamp:
    Container ID:   docker://296e90080cb8907bebb0d87a6dd066141ac949658211604ae4ba3531c428b548
    Image:          gcr.io/google-samples/kubernetes-bootcamp:v1
    Image ID:       docker-pullable://gcr.io/google-samples/kubernetes-bootcamp@sha256:0d6b8ee63bb57c5f5b6156f446b3bc3b3c143d233037f3a2f00e279c8fcc64af
    Port:           8080/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Fri, 08 Jun 2018 11:54:40 +0000
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-pjfqj (ro)
Conditions:
  Type           Status
  Initialized    True
  Ready          True
  PodScheduled   True
Volumes:
  default-token-pjfqj:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  default-token-pjfqj
    Optional:    false
QoS Class:       BestEffort
Node-Selectors:  <none>
Tolerations:     node.kubernetes.io/not-ready:NoExecute for 300s
                 node.kubernetes.io/unreachable:NoExecute for 300s
Events:
  Type     Reason                 Age              From               Message
  ----     ------                 ----             ----               -------
  Warning  FailedScheduling       4m (x3 over 4m)  default-scheduler  0/1 nodes are available: 1 node(s) were not ready.
  Normal   Scheduled              4m               default-scheduler  Successfully assigned kubernetes-bootcamp-5c69669756-dnlsd to minikube
  Normal   SuccessfulMountVolume  4m               kubelet, minikube  MountVolume.SetUp succeeded for volume "default-token-pjfqj"
  Normal   Pulled                 4m               kubelet, minikube  Container image"gcr.io/google-samples/kubernetes-bootcamp:v1" already present on machine
  Normal   Created                4m               kubelet, minikube  Created container
  Normal   Started                4m               kubelet, minikube  Started container


Name:           kubernetes-bootcamp-5c69669756-wxqp6
Namespace:      default
Node:           minikube/172.17.0.141
Start Time:     Fri, 08 Jun 2018 11:54:37 +0000
Labels:         pod-template-hash=1725225312
                run=kubernetes-bootcamp
Annotations:    <none>
Status:         Running
IP:             172.18.0.5
Controlled By:  ReplicaSet/kubernetes-bootcamp-5c69669756
Containers:
  kubernetes-bootcamp:
    Container ID:   docker://6578ad4dd85d84358752dc51bbe3602f4d3ea663d220013ff8a73b3ac1689a77
    Image:          gcr.io/google-samples/kubernetes-bootcamp:v1
    Image ID:       docker-pullable://gcr.io/google-samples/kubernetes-bootcamp@sha256:0d6b8ee63bb57c5f5b6156f446b3bc3b3c143d233037f3a2f00e279c8fcc64af
    Port:           8080/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Fri, 08 Jun 2018 11:54:40 +0000
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-pjfqj (ro)
Conditions:
  Type           Status
  Initialized    True
  Ready          True
  PodScheduled   True
Volumes:
  default-token-pjfqj:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  default-token-pjfqj
    Optional:    false
QoS Class:       BestEffort
Node-Selectors:  <none>
Tolerations:     node.kubernetes.io/not-ready:NoExecute for 300s
                 node.kubernetes.io/unreachable:NoExecute for 300s
Events:
  Type     Reason                 Age              From               Message
  ----     ------                 ----             ----               -------
  Warning  FailedScheduling       4m (x3 over 4m)  default-scheduler  0/1 nodes are available: 1 node(s) were not ready.
  Normal   Scheduled              4m               default-scheduler  Successfully assigned kubernetes-bootcamp-5c69669756-wxqp6 to minikube
  Normal   SuccessfulMountVolume  4m               kubelet, minikube  MountVolume.SetUp succeeded for volume "default-token-pjfqj"
  Normal   Pulled                 4m               kubelet, minikube  Container image"gcr.io/google-samples/kubernetes-bootcamp:v1" already present on machine
  Normal   Created                4m               kubelet, minikube  Created container
  Normal   Started                4m               kubelet, minikube  Started container
```

更新deployments的镜像版本V2

```shell
$ kubectl set image deployments/kubernetes-bootcamp kubernetes-bootcamp=jocatalin/kubernetes-bootcamp:v2
```

获取**pod**查看状态

```shell
$ kubectl get pods
NAME                                   READY     STATUS              RESTARTS   AGE
kubernetes-bootcamp-74f45db6ff-fjqzk   0/1       ContainerCreating   0          3s
kubernetes-bootcamp-74f45db6ff-ts4gf   0/1       ContainerCreating   0          3s
kubernetes-bootcamp-7799cbcb86-bqxwx   1/1       Running             0          5m
kubernetes-bootcamp-7799cbcb86-cbf6k   1/1       Running             0          5m
kubernetes-bootcamp-7799cbcb86-hmx87   1/1       Terminating         0          5m
kubernetes-bootcamp-7799cbcb86-qmtwk   1/1       Running             0          5m

$ kubectl get pods
NAME                                   READY     STATUS        RESTARTS   AGE
kubernetes-bootcamp-74f45db6ff-9tj44   1/1       Running       0          15s
kubernetes-bootcamp-74f45db6ff-dxlzs   1/1       Running       0          16s
kubernetes-bootcamp-74f45db6ff-fjqzk   1/1       Running       0          19s
kubernetes-bootcamp-74f45db6ff-ts4gf   1/1       Running       0          19s
kubernetes-bootcamp-7799cbcb86-bqxwx   1/1       Terminating   0          5m
kubernetes-bootcamp-7799cbcb86-cbf6k   1/1       Terminating   0          5m
kubernetes-bootcamp-7799cbcb86-hmx87   1/1       Terminating   0          5m
kubernetes-bootcamp-7799cbcb86-qmtwk   1/1       Terminating   0          5m

$ kubectl get pods
NAME                                   READY     STATUS        RESTARTS   AGE
kubernetes-bootcamp-74f45db6ff-9tj44   1/1       Running       0          30s
kubernetes-bootcamp-74f45db6ff-dxlzs   1/1       Running       0          31s
kubernetes-bootcamp-74f45db6ff-fjqzk   1/1       Running       0          34s
kubernetes-bootcamp-74f45db6ff-ts4gf   1/1       Running       0          34s
kubernetes-bootcamp-7799cbcb86-bqxwx   1/1       Terminating   0          6m
kubernetes-bootcamp-7799cbcb86-cbf6k   1/1       Terminating   0          6m
kubernetes-bootcamp-7799cbcb86-qmtwk   0/1       Terminating   0          6m

$ kubectl get pods
NAME                                   READY     STATUS    RESTARTS   AGE
kubernetes-bootcamp-74f45db6ff-9tj44   1/1       Running   0          42s
kubernetes-bootcamp-74f45db6ff-dxlzs   1/1       Running   0          43s
kubernetes-bootcamp-74f45db6ff-fjqzk   1/1       Running   0          46s
kubernetes-bootcamp-74f45db6ff-ts4gf   1/1       Running   0          46s
```



#### 确认更新

查看当前状态

```shell
$ kubectl describe services/kubernetes-bootcamp
Name:                     kubernetes-bootcamp
Namespace:                default
Labels:                   run=kubernetes-bootcamp
Annotations:              <none>
Selector:                 run=kubernetes-bootcamp
Type:                     NodePort
IP:                       10.102.206.195
Port:                     <unset>  8080/TCP
TargetPort:               8080/TCP
NodePort:                 <unset>  30988/TCP
Endpoints:                172.18.0.10:8080,172.18.0.11:8080,172.18.0.8:8080 + 1 more...
Session Affinity:         None
External Traffic Policy:  Cluster
Events:                   <none>
```

设置变量 **NODE_PORT** 

```shell
$ export NODE_PORT=$(kubectl get services/kubernetes-bootcamp -o go-template='{{(index .spec.ports 0).nodePort}}')
$ echo NODE_PORT=$NODE_PORT
```

外网访问

```shell
$ curl $(minikube ip):$NODE_PORT
Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-7799cbcb86-89b5r | v=2
$ curl $(minikube ip):$NODE_PORT
Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-7799cbcb86-89b5r | v=2
$ curl $(minikube ip):$NODE_PORT
Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-7799cbcb86-znx2c | v=2
$ curl $(minikube ip):$NODE_PORT
Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-7799cbcb86-pwfvj | v=2
$ curl $(minikube ip):$NODE_PORT
Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-7799cbcb86-znx2c | v=2
$ curl $(minikube ip):$NODE_PORT
Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-7799cbcb86-89b5r | v=2
$ curl $(minikube ip):$NODE_PORT
Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-7799cbcb86-zc29d | v=2
$ curl $(minikube ip):$NODE_PORT
Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-7799cbcb86-zc29d | v=2
$ curl $(minikube ip):$NODE_PORT
Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-7799cbcb86-89b5r | v=2
$ curl $(minikube ip):$NODE_PORT
Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-7799cbcb86-pwfvj | v=2
```

对于上述，重复请求，发现每次打到后面的**pod**的服务时不相同的，使用了的负载均衡。

查看回滚的状态：

```shell
$ kubectl rollout status deployments/kubernetes-bootcamp
deployment "kubernetes-bootcamp" successfully rolled out
$ kubectl get pods
NAME                                   READY     STATUS    RESTARTS   AGE
kubernetes-bootcamp-7799cbcb86-89b5r   1/1       Running   0          8m
kubernetes-bootcamp-7799cbcb86-pwfvj   1/1       Running   0          8m
kubernetes-bootcamp-7799cbcb86-zc29d   1/1       Running   0          8m
kubernetes-bootcamp-7799cbcb86-znx2c   1/1       Running   0          8m
```

查看此时的**pod**版本

```shell
$ kubectl describe pods
Name:           kubernetes-bootcamp-7799cbcb86-89b5r
Namespace:      default
Node:           minikube/172.17.0.141
Start Time:     Fri, 08 Jun 2018 12:08:49 +0000
Labels:         pod-template-hash=3355767642
                run=kubernetes-bootcamp
Annotations:    <none>
Status:         Running
IP:             172.18.0.9
Controlled By:  ReplicaSet/kubernetes-bootcamp-7799cbcb86
Containers:
  kubernetes-bootcamp:
    Container ID:   docker://9803fba1f1ba3371b294a9f91574b857dc77147ab23d024a1fbab7b09c658430
    Image:          jocatalin/kubernetes-bootcamp:v2
    Image ID:       docker-pullable://jocatalin/kubernetes-bootcamp@sha256:fb1a3ced00cecfc1f83f18ab5cd14199e30adc1b49aa4244f5d65ad3f5feb2a5
    Port:           8080/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Fri, 08 Jun 2018 12:08:50 +0000
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-pjfqj (ro)
Conditions:
  Type           Status
  Initialized    True
  Ready          True
  PodScheduled   True
Volumes:
  default-token-pjfqj:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  default-token-pjfqj
    Optional:    false
QoS Class:       BestEffort
Node-Selectors:  <none>
Tolerations:     node.kubernetes.io/not-ready:NoExecute for 300s
                 node.kubernetes.io/unreachable:NoExecute for 300s
Events:
  Type    Reason                 Age   From               Message
  ----    ------                 ----  ----               -------
  Normal  Scheduled              9m    default-scheduler  Successfully assigned kubernetes-bootcamp-7799cbcb86-89b5r to minikube
  Normal  SuccessfulMountVolume  9m    kubelet, minikube  MountVolume.SetUp succeededfor volume "default-token-pjfqj"
  Normal  Pulled                 9m    kubelet, minikube  Container image "jocatalin/kubernetes-bootcamp:v2" already present on machine
  Normal  Created                9m    kubelet, minikube  Created container
  Normal  Started                9m    kubelet, minikube  Started container


Name:           kubernetes-bootcamp-7799cbcb86-pwfvj
Namespace:      default
Node:           minikube/172.17.0.141
Start Time:     Fri, 08 Jun 2018 12:08:51 +0000
Labels:         pod-template-hash=3355767642
                run=kubernetes-bootcamp
Annotations:    <none>
Status:         Running
IP:             172.18.0.10
Controlled By:  ReplicaSet/kubernetes-bootcamp-7799cbcb86
Containers:
  kubernetes-bootcamp:
    Container ID:   docker://0e5cb1d7c2ecaf627e5233271d94a87e644ecdb733faf574d9566788cd2c0c4d
    Image:          jocatalin/kubernetes-bootcamp:v2
    Image ID:       docker-pullable://jocatalin/kubernetes-bootcamp@sha256:fb1a3ced00cecfc1f83f18ab5cd14199e30adc1b49aa4244f5d65ad3f5feb2a5
    Port:           8080/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Fri, 08 Jun 2018 12:08:52 +0000
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-pjfqj (ro)
Conditions:
  Type           Status
  Initialized    True
  Ready          True
  PodScheduled   True
Volumes:
  default-token-pjfqj:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  default-token-pjfqj
    Optional:    false
QoS Class:       BestEffort
Node-Selectors:  <none>
Tolerations:     node.kubernetes.io/not-ready:NoExecute for 300s
                 node.kubernetes.io/unreachable:NoExecute for 300s
Events:
  Type    Reason                 Age   From               Message
  ----    ------                 ----  ----               -------
  Normal  Scheduled              9m    default-scheduler  Successfully assigned kubernetes-bootcamp-7799cbcb86-pwfvj to minikube
  Normal  SuccessfulMountVolume  9m    kubelet, minikube  MountVolume.SetUp succeededfor volume "default-token-pjfqj"
  Normal  Pulled                 9m    kubelet, minikube  Container image "jocatalin/kubernetes-bootcamp:v2" already present on machine
  Normal  Created                9m    kubelet, minikube  Created container
  Normal  Started                9m    kubelet, minikube  Started container


Name:           kubernetes-bootcamp-7799cbcb86-zc29d
Namespace:      default
Node:           minikube/172.17.0.141
Start Time:     Fri, 08 Jun 2018 12:08:49 +0000
Labels:         pod-template-hash=3355767642
                run=kubernetes-bootcamp
Annotations:    <none>
Status:         Running
IP:             172.18.0.8
Controlled By:  ReplicaSet/kubernetes-bootcamp-7799cbcb86
Containers:
  kubernetes-bootcamp:
    Container ID:   docker://8e53a5ea1001f456a8d25582ca5da8352a8bbf5ba164c87160def7955ac94132
    Image:          jocatalin/kubernetes-bootcamp:v2
    Image ID:       docker-pullable://jocatalin/kubernetes-bootcamp@sha256:fb1a3ced00cecfc1f83f18ab5cd14199e30adc1b49aa4244f5d65ad3f5feb2a5
    Port:           8080/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Fri, 08 Jun 2018 12:08:50 +0000
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-pjfqj (ro)
Conditions:
  Type           Status
  Initialized    True
  Ready          True
  PodScheduled   True
Volumes:
  default-token-pjfqj:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  default-token-pjfqj
    Optional:    false
QoS Class:       BestEffort
Node-Selectors:  <none>
Tolerations:     node.kubernetes.io/not-ready:NoExecute for 300s
                 node.kubernetes.io/unreachable:NoExecute for 300s
Events:
  Type    Reason                 Age   From               Message
  ----    ------                 ----  ----               -------
  Normal  Scheduled              9m    default-scheduler  Successfully assigned kubernetes-bootcamp-7799cbcb86-zc29d to minikube
  Normal  SuccessfulMountVolume  9m    kubelet, minikube  MountVolume.SetUp succeededfor volume "default-token-pjfqj"
  Normal  Pulled                 9m    kubelet, minikube  Container image "jocatalin/kubernetes-bootcamp:v2" already present on machine
  Normal  Created                9m    kubelet, minikube  Created container
  Normal  Started                9m    kubelet, minikube  Started container


Name:           kubernetes-bootcamp-7799cbcb86-znx2c
Namespace:      default
Node:           minikube/172.17.0.141
Start Time:     Fri, 08 Jun 2018 12:08:51 +0000
Labels:         pod-template-hash=3355767642
                run=kubernetes-bootcamp
Annotations:    <none>
Status:         Running
IP:             172.18.0.11
Controlled By:  ReplicaSet/kubernetes-bootcamp-7799cbcb86
Containers:
  kubernetes-bootcamp:
    Container ID:   docker://11a576d02938571fda4a927a05a89421205d46aceb2af3131ddcbe0d1808d273
    Image:          jocatalin/kubernetes-bootcamp:v2
    Image ID:       docker-pullable://jocatalin/kubernetes-bootcamp@sha256:fb1a3ced00cecfc1f83f18ab5cd14199e30adc1b49aa4244f5d65ad3f5feb2a5
    Port:           8080/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Fri, 08 Jun 2018 12:08:52 +0000
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-pjfqj (ro)
Conditions:
  Type           Status
  Initialized    True
  Ready          True
  PodScheduled   True
Volumes:
  default-token-pjfqj:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  default-token-pjfqj
    Optional:    false
QoS Class:       BestEffort
Node-Selectors:  <none>
Tolerations:     node.kubernetes.io/not-ready:NoExecute for 300s
                 node.kubernetes.io/unreachable:NoExecute for 300s
Events:
  Type    Reason                 Age   From               Message
  ----    ------                 ----  ----               -------
  Normal  Scheduled              9m    default-scheduler  Successfully assigned kubernetes-bootcamp-7799cbcb86-znx2c to minikube
  Normal  SuccessfulMountVolume  9m    kubelet, minikube  MountVolume.SetUp succeededfor volume "default-token-pjfqj"
  Normal  Pulled                 9m    kubelet, minikube  Container image "jocatalin/kubernetes-bootcamp:v2" already present on machine
  Normal  Created                9m    kubelet, minikube  Created container
  Normal  Started                9m    kubelet, minikube  Started container
```

#### 回滚更新

更新**deployments**版本为v10

```shell
$ kubectl set image deployments/kubernetes-bootcamp kubernetes-bootcamp=gcr.io/google-samples/kubernetes-bootcamp:v10
```

获取**deployments**详情

```shell
$ kubectl get deployments
NAME                  DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
kubernetes-bootcamp   4         5         2            3           27m
```

查看**pods**

```shell
$ kubectl get pods
NAME                                   READY     STATUS             RESTARTS   AGE
kubernetes-bootcamp-5f76cd7b94-7ld4l   0/1       ImagePullBackOff   0          2m
kubernetes-bootcamp-5f76cd7b94-pv9sn   0/1       ImagePullBackOff   0          2m
kubernetes-bootcamp-7799cbcb86-89b5r   1/1       Running            0          14m
kubernetes-bootcamp-7799cbcb86-zc29d   1/1       Running            0          14m
kubernetes-bootcamp-7799cbcb86-znx2c   1/1       Running            0          14m
```

获取**pods**详情

```shell
$ kubectl describe pods
Name:           kubernetes-bootcamp-5f76cd7b94-7ld4l
Namespace:      default
Node:           minikube/172.17.0.141
Start Time:     Fri, 08 Jun 2018 12:21:22 +0000
Labels:         pod-template-hash=1932783650
                run=kubernetes-bootcamp
Annotations:    <none>
Status:         Pending
IP:             172.18.0.4
Controlled By:  ReplicaSet/kubernetes-bootcamp-5f76cd7b94
Containers:
  kubernetes-bootcamp:
    Container ID:
    Image:          gcr.io/google-samples/kubernetes-bootcamp:v10
    Image ID:
    Port:           8080/TCP
    Host Port:      0/TCP
    State:          Waiting
      Reason:       ImagePullBackOff
    Ready:          False
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-pjfqj (ro)
Conditions:
  Type           Status
  Initialized    True
  Ready          False
  PodScheduled   True
Volumes:
  default-token-pjfqj:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  default-token-pjfqj
    Optional:    false
QoS Class:       BestEffort
Node-Selectors:  <none>
Tolerations:     node.kubernetes.io/not-ready:NoExecute for 300s
                 node.kubernetes.io/unreachable:NoExecute for 300s
Events:
  Type     Reason                 Age              From               Message
  ----     ------                 ----             ----               -------
  Normal   Scheduled              3m               default-scheduler  Successfully assigned kubernetes-bootcamp-5f76cd7b94-7ld4l to minikube
  Normal   SuccessfulMountVolume  3m               kubelet, minikube  MountVolume.SetUp succeeded for volume "default-token-pjfqj"
  Normal   Pulling                1m (x4 over 3m)  kubelet, minikube  pulling image "gcr.io/google-samples/kubernetes-bootcamp:v10"
  Warning  Failed                 1m (x4 over 3m)  kubelet, minikube  Failed to pull image "gcr.io/google-samples/kubernetes-bootcamp:v10": rpc error: code = Unknown desc = unauthorized: authentication required
  Warning  Failed                 1m (x4 over 3m)  kubelet, minikube  Error: ErrImagePull
  Normal   BackOff                1m (x6 over 3m)  kubelet, minikube  Back-off pulling image "gcr.io/google-samples/kubernetes-bootcamp:v10"
  Warning  Failed                 1m (x6 over 3m)  kubelet, minikube  Error: ImagePullBackOff


Name:           kubernetes-bootcamp-5f76cd7b94-pv9sn
Namespace:      default
Node:           minikube/172.17.0.141
Start Time:     Fri, 08 Jun 2018 12:21:19 +0000
Labels:         pod-template-hash=1932783650
                run=kubernetes-bootcamp
Annotations:    <none>
Status:         Pending
IP:             172.18.0.3
Controlled By:  ReplicaSet/kubernetes-bootcamp-5f76cd7b94
Containers:
  kubernetes-bootcamp:
    Container ID:
    Image:          gcr.io/google-samples/kubernetes-bootcamp:v10
    Image ID:
    Port:           8080/TCP
    Host Port:      0/TCP
    State:          Waiting
      Reason:       ImagePullBackOff
    Ready:          False
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-pjfqj (ro)
Conditions:
  Type           Status
  Initialized    True
  Ready          False
  PodScheduled   True
Volumes:
  default-token-pjfqj:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  default-token-pjfqj
    Optional:    false
QoS Class:       BestEffort
Node-Selectors:  <none>
Tolerations:     node.kubernetes.io/not-ready:NoExecute for 300s
                 node.kubernetes.io/unreachable:NoExecute for 300s
Events:
  Type     Reason                 Age              From               Message
  ----     ------                 ----             ----               -------
  Normal   Scheduled              3m               default-scheduler  Successfully assigned kubernetes-bootcamp-5f76cd7b94-pv9sn to minikube
  Normal   SuccessfulMountVolume  3m               kubelet, minikube  MountVolume.SetUp succeeded for volume "default-token-pjfqj"
  Normal   Pulling                1m (x4 over 3m)  kubelet, minikube  pulling image "gcr.io/google-samples/kubernetes-bootcamp:v10"
  Warning  Failed                 1m (x4 over 3m)  kubelet, minikube  Failed to pull image "gcr.io/google-samples/kubernetes-bootcamp:v10": rpc error: code = Unknown desc = unauthorized: authentication required
  Warning  Failed                 1m (x4 over 3m)  kubelet, minikube  Error: ErrImagePull
  Normal   BackOff                1m (x6 over 3m)  kubelet, minikube  Back-off pulling image "gcr.io/google-samples/kubernetes-bootcamp:v10"
  Warning  Failed                 1m (x6 over 3m)  kubelet, minikube  Error: ImagePullBackOff


Name:           kubernetes-bootcamp-7799cbcb86-89b5r
Namespace:      default
Node:           minikube/172.17.0.141
Start Time:     Fri, 08 Jun 2018 12:08:49 +0000
Labels:         pod-template-hash=3355767642
                run=kubernetes-bootcamp
Annotations:    <none>
Status:         Running
IP:             172.18.0.9
Controlled By:  ReplicaSet/kubernetes-bootcamp-7799cbcb86
Containers:
  kubernetes-bootcamp:
    Container ID:   docker://9803fba1f1ba3371b294a9f91574b857dc77147ab23d024a1fbab7b09c658430
    Image:          jocatalin/kubernetes-bootcamp:v2
    Image ID:       docker-pullable://jocatalin/kubernetes-bootcamp@sha256:fb1a3ced00cecfc1f83f18ab5cd14199e30adc1b49aa4244f5d65ad3f5feb2a5
    Port:           8080/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Fri, 08 Jun 2018 12:08:50 +0000
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-pjfqj (ro)
Conditions:
  Type           Status
  Initialized    True
  Ready          True
  PodScheduled   True
Volumes:
  default-token-pjfqj:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  default-token-pjfqj
    Optional:    false
QoS Class:       BestEffort
Node-Selectors:  <none>
Tolerations:     node.kubernetes.io/not-ready:NoExecute for 300s
                 node.kubernetes.io/unreachable:NoExecute for 300s
Events:
  Type    Reason                 Age   From               Message
  ----    ------                 ----  ----               -------
  Normal  Scheduled              15m   default-scheduler  Successfully assigned kubernetes-bootcamp-7799cbcb86-89b5r to minikube
  Normal  SuccessfulMountVolume  15m   kubelet, minikube  MountVolume.SetUp succeededfor volume "default-token-pjfqj"
  Normal  Pulled                 15m   kubelet, minikube  Container image "jocatalin/kubernetes-bootcamp:v2" already present on machine
  Normal  Created                15m   kubelet, minikube  Created container
  Normal  Started                15m   kubelet, minikube  Started container


Name:           kubernetes-bootcamp-7799cbcb86-zc29d
Namespace:      default
Node:           minikube/172.17.0.141
Start Time:     Fri, 08 Jun 2018 12:08:49 +0000
Labels:         pod-template-hash=3355767642
                run=kubernetes-bootcamp
Annotations:    <none>
Status:         Running
IP:             172.18.0.8
Controlled By:  ReplicaSet/kubernetes-bootcamp-7799cbcb86
Containers:
  kubernetes-bootcamp:
    Container ID:   docker://8e53a5ea1001f456a8d25582ca5da8352a8bbf5ba164c87160def7955ac94132
    Image:          jocatalin/kubernetes-bootcamp:v2
    Image ID:       docker-pullable://jocatalin/kubernetes-bootcamp@sha256:fb1a3ced00cecfc1f83f18ab5cd14199e30adc1b49aa4244f5d65ad3f5feb2a5
    Port:           8080/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Fri, 08 Jun 2018 12:08:50 +0000
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-pjfqj (ro)
Conditions:
  Type           Status
  Initialized    True
  Ready          True
  PodScheduled   True
Volumes:
  default-token-pjfqj:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  default-token-pjfqj
    Optional:    false
QoS Class:       BestEffort
Node-Selectors:  <none>
Tolerations:     node.kubernetes.io/not-ready:NoExecute for 300s
                 node.kubernetes.io/unreachable:NoExecute for 300s
Events:
  Type    Reason                 Age   From               Message
  ----    ------                 ----  ----               -------
  Normal  Scheduled              15m   default-scheduler  Successfully assigned kubernetes-bootcamp-7799cbcb86-zc29d to minikube
  Normal  SuccessfulMountVolume  15m   kubelet, minikube  MountVolume.SetUp succeededfor volume "default-token-pjfqj"
  Normal  Pulled                 15m   kubelet, minikube  Container image "jocatalin/kubernetes-bootcamp:v2" already present on machine
  Normal  Created                15m   kubelet, minikube  Created container
  Normal  Started                15m   kubelet, minikube  Started container


Name:           kubernetes-bootcamp-7799cbcb86-znx2c
Namespace:      default
Node:           minikube/172.17.0.141
Start Time:     Fri, 08 Jun 2018 12:08:51 +0000
Labels:         pod-template-hash=3355767642
                run=kubernetes-bootcamp
Annotations:    <none>
Status:         Running
IP:             172.18.0.11
Controlled By:  ReplicaSet/kubernetes-bootcamp-7799cbcb86
Containers:
  kubernetes-bootcamp:
    Container ID:   docker://11a576d02938571fda4a927a05a89421205d46aceb2af3131ddcbe0d1808d273
    Image:          jocatalin/kubernetes-bootcamp:v2
    Image ID:       docker-pullable://jocatalin/kubernetes-bootcamp@sha256:fb1a3ced00cecfc1f83f18ab5cd14199e30adc1b49aa4244f5d65ad3f5feb2a5
    Port:           8080/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Fri, 08 Jun 2018 12:08:52 +0000
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-pjfqj (ro)
Conditions:
  Type           Status
  Initialized    True
  Ready          True
  PodScheduled   True
Volumes:
  default-token-pjfqj:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  default-token-pjfqj
    Optional:    false
QoS Class:       BestEffort
Node-Selectors:  <none>
Tolerations:     node.kubernetes.io/not-ready:NoExecute for 300s
                 node.kubernetes.io/unreachable:NoExecute for 300s
Events:
  Type    Reason                 Age   From               Message
  ----    ------                 ----  ----               -------
  Normal  Scheduled              15m   default-scheduler  Successfully assigned kubernetes-bootcamp-7799cbcb86-znx2c to minikube
  Normal  SuccessfulMountVolume  15m   kubelet, minikube  MountVolume.SetUp succeededfor volume "default-token-pjfqj"
  Normal  Pulled                 15m   kubelet, minikube  Container image "jocatalin/kubernetes-bootcamp:v2" already present on machine
  Normal  Created                15m   kubelet, minikube  Created container
  Normal  Started                15m   kubelet, minikube  Started container
```

因为远程并没有v10版本的镜像，所以，此时我们可以使用**rollout**撤销操作

```shell
$ kubectl rollout undo deployments/kubernetes-bootcamp
deployment.apps "kubernetes-bootcamp"
```

查看**pod**详情

```shell
$ kubectl rollout undo deployments/kubernetes-bootcamp
deployment.apps "kubernetes-bootcamp"
$ kubectl get pods
NAME                                   READY     STATUS             RESTARTS   AGE
kubernetes-bootcamp-5f76cd7b94-6nnk9   0/1       ImagePullBackOff   0          1m
kubernetes-bootcamp-5f76cd7b94-nsxx5   0/1       ErrImagePull       0          1m
kubernetes-bootcamp-7799cbcb86-89b5r   1/1       Running            0          20m
kubernetes-bootcamp-7799cbcb86-zc29d   1/1       Running            0          20m
kubernetes-bootcamp-7799cbcb86-znx2c   1/1       Running            0          20m
$ kubectl get pods
NAME                                   READY     STATUS        RESTARTS   AGE
kubernetes-bootcamp-5f76cd7b94-nsxx5   0/1       Terminating   0          1m
kubernetes-bootcamp-7799cbcb86-89b5r   1/1       Running       0          20m
kubernetes-bootcamp-7799cbcb86-dk75k   1/1       Running       0          8s
kubernetes-bootcamp-7799cbcb86-zc29d   1/1       Running       0          20m
kubernetes-bootcamp-7799cbcb86-znx2c   1/1       Running       0          20m
$ kubectl get pods
NAME                                   READY     STATUS    RESTARTS   AGE
kubernetes-bootcamp-7799cbcb86-89b5r   1/1       Running   0          20m
kubernetes-bootcamp-7799cbcb86-dk75k   1/1       Running   0          10s
kubernetes-bootcamp-7799cbcb86-zc29d   1/1       Running   0          20m
kubernetes-bootcamp-7799cbcb86-znx2c   1/1       Running   0          20m
```

此时查看**pod**描述

```shell
$ kubectl describe pods
Name:           kubernetes-bootcamp-7799cbcb86-89b5r
Namespace:      default
Node:           minikube/172.17.0.141
Start Time:     Fri, 08 Jun 2018 12:08:49 +0000
Labels:         pod-template-hash=3355767642
                run=kubernetes-bootcamp
Annotations:    <none>
Status:         Running
IP:             172.18.0.9
Controlled By:  ReplicaSet/kubernetes-bootcamp-7799cbcb86
Containers:
  kubernetes-bootcamp:
    Container ID:   docker://9803fba1f1ba3371b294a9f91574b857dc77147ab23d024a1fbab7b09c658430
    Image:          jocatalin/kubernetes-bootcamp:v2
    Image ID:       docker-pullable://jocatalin/kubernetes-bootcamp@sha256:fb1a3ced00cecfc1f83f18ab5cd14199e30adc1b49aa4244f5d65ad3f5feb2a5
    Port:           8080/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Fri, 08 Jun 2018 12:08:50 +0000
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-pjfqj (ro)
Conditions:
  Type           Status
  Initialized    True
  Ready          True
  PodScheduled   True
Volumes:
  default-token-pjfqj:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  default-token-pjfqj
    Optional:    false
QoS Class:       BestEffort
Node-Selectors:  <none>
Tolerations:     node.kubernetes.io/not-ready:NoExecute for 300s
                 node.kubernetes.io/unreachable:NoExecute for 300s
Events:
  Type    Reason                 Age   From               Message
  ----    ------                 ----  ----               -------
  Normal  Scheduled              22m   default-scheduler  Successfully assigned kubernetes-bootcamp-7799cbcb86-89b5r to minikube
  Normal  SuccessfulMountVolume  22m   kubelet, minikube  MountVolume.SetUp succeededfor volume "default-token-pjfqj"
  Normal  Pulled                 22m   kubelet, minikube  Container image "jocatalin/kubernetes-bootcamp:v2" already present on machine
  Normal  Created                22m   kubelet, minikube  Created container
  Normal  Started                22m   kubelet, minikube  Started container


Name:           kubernetes-bootcamp-7799cbcb86-dk75k
Namespace:      default
Node:           minikube/172.17.0.141
Start Time:     Fri, 08 Jun 2018 12:29:05 +0000
Labels:         pod-template-hash=3355767642
                run=kubernetes-bootcamp
Annotations:    <none>
Status:         Running
IP:             172.18.0.3
Controlled By:  ReplicaSet/kubernetes-bootcamp-7799cbcb86
Containers:
  kubernetes-bootcamp:
    Container ID:   docker://fffbcfc1a9815217fad703d23ec57e076aa7bdf1b702201acbfcd50e4ccc9426
    Image:          jocatalin/kubernetes-bootcamp:v2
    Image ID:       docker-pullable://jocatalin/kubernetes-bootcamp@sha256:fb1a3ced00cecfc1f83f18ab5cd14199e30adc1b49aa4244f5d65ad3f5feb2a5
    Port:           8080/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Fri, 08 Jun 2018 12:29:08 +0000
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-pjfqj (ro)
Conditions:
  Type           Status
  Initialized    True
  Ready          True
  PodScheduled   True
Volumes:
  default-token-pjfqj:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  default-token-pjfqj
    Optional:    false
QoS Class:       BestEffort
Node-Selectors:  <none>
Tolerations:     node.kubernetes.io/not-ready:NoExecute for 300s
                 node.kubernetes.io/unreachable:NoExecute for 300s
Events:
  Type    Reason                 Age   From               Message
  ----    ------                 ----  ----               -------
  Normal  Scheduled              1m    default-scheduler  Successfully assigned kubernetes-bootcamp-7799cbcb86-dk75k to minikube
  Normal  SuccessfulMountVolume  1m    kubelet, minikube  MountVolume.SetUp succeededfor volume "default-token-pjfqj"
  Normal  Pulled                 1m    kubelet, minikube  Container image "jocatalin/kubernetes-bootcamp:v2" already present on machine
  Normal  Created                1m    kubelet, minikube  Created container
  Normal  Started                1m    kubelet, minikube  Started container


Name:           kubernetes-bootcamp-7799cbcb86-zc29d
Namespace:      default
Node:           minikube/172.17.0.141
Start Time:     Fri, 08 Jun 2018 12:08:49 +0000
Labels:         pod-template-hash=3355767642
                run=kubernetes-bootcamp
Annotations:    <none>
Status:         Running
IP:             172.18.0.8
Controlled By:  ReplicaSet/kubernetes-bootcamp-7799cbcb86
Containers:
  kubernetes-bootcamp:
    Container ID:   docker://8e53a5ea1001f456a8d25582ca5da8352a8bbf5ba164c87160def7955ac94132
    Image:          jocatalin/kubernetes-bootcamp:v2
    Image ID:       docker-pullable://jocatalin/kubernetes-bootcamp@sha256:fb1a3ced00cecfc1f83f18ab5cd14199e30adc1b49aa4244f5d65ad3f5feb2a5
    Port:           8080/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Fri, 08 Jun 2018 12:08:50 +0000
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-pjfqj (ro)
Conditions:
  Type           Status
  Initialized    True
  Ready          True
  PodScheduled   True
Volumes:
  default-token-pjfqj:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  default-token-pjfqj
    Optional:    false
QoS Class:       BestEffort
Node-Selectors:  <none>
Tolerations:     node.kubernetes.io/not-ready:NoExecute for 300s
                 node.kubernetes.io/unreachable:NoExecute for 300s
Events:
  Type    Reason                 Age   From               Message
  ----    ------                 ----  ----               -------
  Normal  Scheduled              22m   default-scheduler  Successfully assigned kubernetes-bootcamp-7799cbcb86-zc29d to minikube
  Normal  SuccessfulMountVolume  22m   kubelet, minikube  MountVolume.SetUp succeededfor volume "default-token-pjfqj"
  Normal  Pulled                 22m   kubelet, minikube  Container image "jocatalin/kubernetes-bootcamp:v2" already present on machine
  Normal  Created                22m   kubelet, minikube  Created container
  Normal  Started                22m   kubelet, minikube  Started container


Name:           kubernetes-bootcamp-7799cbcb86-znx2c
Namespace:      default
Node:           minikube/172.17.0.141
Start Time:     Fri, 08 Jun 2018 12:08:51 +0000
Labels:         pod-template-hash=3355767642
                run=kubernetes-bootcamp
Annotations:    <none>
Status:         Running
IP:             172.18.0.11
Controlled By:  ReplicaSet/kubernetes-bootcamp-7799cbcb86
Containers:
  kubernetes-bootcamp:
    Container ID:   docker://11a576d02938571fda4a927a05a89421205d46aceb2af3131ddcbe0d1808d273
    Image:          jocatalin/kubernetes-bootcamp:v2
    Image ID:       docker-pullable://jocatalin/kubernetes-bootcamp@sha256:fb1a3ced00cecfc1f83f18ab5cd14199e30adc1b49aa4244f5d65ad3f5feb2a5
    Port:           8080/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Fri, 08 Jun 2018 12:08:52 +0000
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-pjfqj (ro)
Conditions:
  Type           Status
  Initialized    True
  Ready          True
  PodScheduled   True
Volumes:
  default-token-pjfqj:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  default-token-pjfqj
    Optional:    false
QoS Class:       BestEffort
Node-Selectors:  <none>
Tolerations:     node.kubernetes.io/not-ready:NoExecute for 300s
                 node.kubernetes.io/unreachable:NoExecute for 300s
Events:
  Type    Reason                 Age   From               Message
  ----    ------                 ----  ----               -------
  Normal  Scheduled              22m   default-scheduler  Successfully assigned kubernetes-bootcamp-7799cbcb86-znx2c to minikube
  Normal  SuccessfulMountVolume  22m   kubelet, minikube  MountVolume.SetUp succeededfor volume "default-token-pjfqj"
  Normal  Pulled                 22m   kubelet, minikube  Container image "jocatalin/kubernetes-bootcamp:v2" already present on machine
  Normal  Created                22m   kubelet, minikube  Created container
  Normal  Started                22m   kubelet, minikube  Started container
```

查看pod上的镜像都回滚为v2版本。

![wallhaven-102452](/img/2018/06/face/wallhaven-102452.png)