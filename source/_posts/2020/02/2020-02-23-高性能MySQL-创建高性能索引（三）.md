---
title: 高性能MySQL-创建高性能索引（三）
author: HoldDie
img: https://www.holddie.com/img/20200223222411.png
top: false
cover: false
coverImg: https://www.holddie.com/img/20200223222411.png
toc: true
mathjax: true
tags:
  - 读书
  - MySQL
date: 2020-02-23 22:11:00
password:
summary: 
categories: MySQL
---



> 索引（在MySQL中也叫做“键（key）”）是存储引擎用于快速找到记录的一种数据结构。



# 5.1　索引基础

- 索引可以包含一个或多个列的值。如果索引包含多个列，那么列的顺序也十分重要，因为MySQL只能高效地使用索引的最左前缀列。
- 创建一个包含两个列的索引，和创建两个只包含一列的索引是大不相同的
- 如果使用的是ORM，是否还需要关心索引？
- 简而言之：是的，仍然需要理解索引，即使是使用对象关系映射（ORM）工具。

## 5.1.1　索引的类型

- 在MySQL中，索引是在存储引擎层而不是服务器层实现的。
- 不同存储引擎的索引的工作方式并不一样，也不是所有的存储引擎都支持所有类型的索引。即使多个存储引擎支持同一种类型的索引，其底层的实现也可能不同。



### B-Tree索引

- 当人们谈论索引的时候，如果没有特别指明类型，那多半说的是B-Tree索引，它使用B-Tree数据结构来存储数据(2)。
- 存储引擎以不同的方式使用B-Tree索引，性能也各有不同，各有优劣。
- MyISAM使用前缀压缩技术使得索引更小，但InnoDB则按照原数据格式进行存储。再如MyISAM索引通过数据的物理位置引用被索引的行，而InnoDB则根据主键引用被索引的行。
- B-Tree通常意味着所有的值都是按顺序存储的，并且每一个叶子页到根的距离相同。
- B-Tree索引能够加快访问数据的速度，因为存储引擎不再需要进行全表扫描来获取需要的数据，取而代之的是从索引的根节点（图示并未画出）开始进行搜索。
- 根节点的槽中存放了指向子节点的指针，存储引擎根据这些指针向下层查找。通过比较节点页的值和要查找的值可以找到合适的指针进入下层子节点，这些指针实际上定义了子节点页中值的上限和下限。最终存储引擎要么是找到对应的值，要么该记录不存在。
- 可以使用B-Tree索引的查询类型。B-Tree索引适用于全键值、键值范围或键前缀查找。其中键前缀查找只适用于根据最左前缀的查找

### 引对如下类型的查询有效。

- 全值匹配全值匹配指的是和索引中的所有列进行匹配，例如前面提到的索引可用于查找姓名为Cuba Allen、出生于1960-01-01的人。
- 匹配最左前缀前面提到的索引可用于查找所有姓为Allen的人，即只使用索引的第一列。
- 匹配列前缀也可以只匹配某一列的值的开头部分。例如前面提到的索引可用于查找所有以J开头的姓的人。
- 匹配范围值例如前面提到的索引可用于查找姓在Allen和Barrymore之间的人。这里也只使用了索引的第一列。
- 精确匹配某一列并范围匹配另外一列前面提到的索引也可用于查找所有姓为Allen，并且名字是字母K开头（比如Kim、Karl等）的人。
- 只访问索引的查询B-Tree通常可以支持“只访问索引的查询”，即查询只需要访问索引，而无须访问数据行。后面我们将单独讨论这种“覆盖索引”的优化。

### B-Tree索引的限制：

- 如果不是按照索引的最左列开始查找，则无法使用索引。
- 不能跳过索引中的列。
- 如果查询中有某个列的范围查询，则其右边所有列都无法使用索引优化查找。

### 哈希索引

- 哈希索引（hash index）基于哈希表实现，只有精确匹配索引所有列的查询才有效(4)。
- 对于每一行数据，存储引擎都会对所有的索引列计算一个哈希码（hash code），哈希码是一个较小的值，并且不同键值的行计算出来的哈希码也不一样。
- 哈希索引将所有的哈希码存储在索引中，同时在哈希表中保存指向每个数据行的指针。
- 在MySQL中，只有Memory引擎显式支持哈希索引。
- Memory引擎是支持非唯一哈希索引的
- 因为索引自身只需存储对应的哈希值，所以索引的结构十分紧凑，这也让哈希索引查找的速度非常快。

#### 哈希索引也有它的限制：

- 哈希索引只包含哈希值和行指针，而不存储字段值，所以不能使用索引中的值来避免读取行。
- 哈希索引数据并不是按照索引值顺序存储的，所以也就无法用于排序。
- 哈希索引也不支持部分索引列匹配查找，因为哈希索引始终是使用索引列的全部内容来计算哈希值的。
- 哈希索引只支持等值比较查询，包括=、IN()、<=>（注意<>和<=>是不同的操作）。也不支持任何范围查询
- 访问哈希索引的数据非常快，除非有很多哈希冲突（不同的索引列值却有相同的哈希值）。当出现哈希冲突的时候，存储引擎必须遍历链表中所有的行指针，逐行进行比较，直到找到所有符合条件的行。
- 如果哈希冲突很多的话，一些索引维护操作的代价也会很高。
- InnoDB引擎有一个特殊的功能叫做“自适应哈希索引（adaptive hash index）”。当InnoDB注意到某些索引值被使用得非常频繁时，它会在内存中基于B-Tree索引之上再创建一个哈希索引，这样就让B-Tree索引也具有哈希索引的一些优点，比如快速的哈希查找。
- 这是一个完全自动的、内部的行为，用户无法控制或者配置，不过如果有必要，完全可以关闭该功能。
- 创建自定义哈希索引。
- 在B-Tree基础上创建一个伪哈希索引。这和真正的哈希索引不是一回事，因为还是使用B-Tree进行查找，但是它使用哈希值而不是键本身进行索引查找。你需要做的就是在查询的WHERE子句中手动指定使用哈希函数。
- 如果采用这种方式，记住不要使用SHA1()和MD5()作为哈希函数。因为这两个函数计算出来的哈希值是非常长的字符串，会浪费大量空间，比较时也会更慢。
- 简单哈希函数的冲突在一个可以接受的范围，同时又能够提供更好的性能。
- 当使用哈希索引进行查询的时候，必须在WHERE子句中包含常量值
- 如果数据表非常大，CRC32()会出现大量的哈希冲突，则可以考虑自己实现一个简单的64位哈希函数。这个自定义函数要返回整数，而不是字符串。一个简单的办法可以使用MD5()函数返回值的一部分来作为自定义哈希函数。

### 空间数据索引（R-Tree）

- MyISAM表支持空间索引，可以用作地理数据存储。和B-Tree索引不同，这类索引无须前缀查询。
- 开源关系数据库系统中对GIS的解决方案做得比较好的是PostgreSQL的PostGIS。

### 全文索引

- 全文索引是一种特殊类型的索引，它查找的是文本中的关键词，而不是直接比较索引中的值。
- 全文搜索和其他几类索引的匹配方式完全不一样。它有许多需要注意的细节，如停用词、词干和复数、布尔搜索等。
- 全文索引更类似于搜索引擎做的事情，而不是简单的WHERE条件匹配。
- 在相同的列上同时创建全文索引和基于值的B-Tree索引不会有冲突，全文索引适用于MATCH AGAINST操作，而不是普通的WHERE条件操作。

### 其他索引类别

- TokuDB使用分形树索引（fractal tree index），这是一类较新开发的数据结构，既有B-Tree的很多优点，也避免了B-Tree的一些缺点。
- ScaleDB使用Patricia tries（这个词不是拼写错误），其他一些存储引擎技术如InfiniDB和Infobright则使用了一些特殊的数据结构来优化某些特殊的查询。



# 5.2　索引的优点

- 最常见的B-Tree索引，按照顺序存储数据，所以MySQL可以用来做ORDER BY和GROUP BY操作。
- 因为数据是有序的，所以B-Tree也就会将相关的列值都存储在一起。



### 索引有如下三个优点：

- 索引大大减少了服务器需要扫描的数据量。
- 索引可以帮助服务器避免排序和临时表。
- 索引可以将随机I/O变为顺序I/O。

### 如何评价一个索引是否适合某个查询的“三星系统”

- 索引将相关的记录放到一起则获得一星；
- 如果索引中的数据顺序和查找中的排列顺序一致则获得二星；
- 如果索引中的列包含了查询中需要的全部列则获得“三星”。

### 索引是最好的解决方案吗?

- 索引并不总是最好的工具。
- 只有当索引帮助存储引擎快速查找到记录带来的好处大于其带来的额外工作时，索引才是有效的。
- 对于非常小的表，大部分情况下简单的全表扫描更高效。
- 对于特大型的表，建立和使用索引的代价将随之增长。
- 如果表的数量特别多，可以建立一个元数据信息表，用来查询需要用到的某些特性。
- 对于TB级别的数据，定位单条记录的意义不大，所以经常会使用块级别元数据技术来替代索引。