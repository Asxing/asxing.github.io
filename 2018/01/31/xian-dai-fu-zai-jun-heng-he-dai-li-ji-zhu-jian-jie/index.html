<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="现代负载均衡和代理技术简介, 编程 读书 生活">
    <meta name="description" content=" 现代网络负载均衡和代理技术简介
最近我注意到，针对负载均衡和代理这两项现代网络技术，有教育意义的介绍性材料相当稀缺。这引起我的思考：为什么会这样？在可靠的分布系统的架构中，负载均衡是核心概念之一，这一地位要求有对应的高质量信息。然而经过搜">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>现代负载均衡和代理技术简介 | Asxing-阿行</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    
    <script src="/libs/jquery/jquery.min.js"></script>
    
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="Asxing-阿行" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Asxing-阿行</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Asxing-阿行</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			Contact
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/asxing" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>

        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/asxing" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/6.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        现代负载均衡和代理技术简介
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/">
                                <span class="chip bg-color">负载均衡</span>
                            </a>
                        
                            <a href="/tags/%E4%BB%A3%E7%90%86/">
                                <span class="chip bg-color">代理</span>
                            </a>
                        
                            <a href="/tags/LV4/">
                                <span class="chip bg-color">LV4</span>
                            </a>
                        
                            <a href="/tags/LV7/">
                                <span class="chip bg-color">LV7</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/" class="post-category">
                                负载均衡
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2018-01-31
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    10.7k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    37 分
                </div>
                
				
                
            </div>
            
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <p> 现代网络负载均衡和代理技术简介</p>
<p>最近我注意到，针对负载均衡和代理这两项现代网络技术，有教育意义的介绍性材料相当稀缺。这引起我的思考：为什么会这样？在可靠的分布系统的架构中，负载均衡是核心概念之一，这一地位要求有对应的高质量信息。然而经过搜索之后，发现这方面的内容的确匮乏。Wikipedia 上的 <a href="https://en.wikipedia.org/wiki/Load_balancing_%28computing%29" target="_blank" rel="noopener">负载均衡</a> 和 <a href="https://en.wikipedia.org/wiki/Proxy_server" target="_blank" rel="noopener">代理服务器</a> 页面只包含了一些相关主题的概念，这些概念的阐述，尤其是微服务架构相关的部分显得相当概括和晦涩。<a href="https://www.google.com/search?q=load+balancing" target="_blank" rel="noopener">Google 搜索 Load Balancing</a>，则会出现一些供应商页面，充斥了各种时髦用词，却罕有细节。</p>
<p>本文里我会尝试对现代网络负载均衡和代理技术进行一些讲解，来弥补上述的材料缺失。平心而论，相关内容中的大量主题足以支撑起一本专著。为了符合我对博客长度的控制习惯，我会将其中一些复杂主题进行概括和提炼，用简单的概要方式进行陈述；根据读者的兴趣和反馈，我可能会在后续文章中对某些话题的细节进行更多的阐述。</p>
<p>上面的内容就是我开始写作本文的动机，下面开始正式内容。</p>
<h2 id="网络负载均衡和代理是什么？"><a href="#网络负载均衡和代理是什么？" class="headerlink" title="网络负载均衡和代理是什么？"></a>网络负载均衡和代理是什么？</h2><p>Wikipedia 对负载均衡的(定义)[<a href="https://en.wikipedia.org/wiki/Load_balancing_%28computing%29]" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Load_balancing_%28computing%29]</a> 是：</p>
<blockquote>
<p>In computing, load balancing improves the distribution of workloads across multiple computing resources, such as computers, a computer cluster, network links, central processing units, or disk drives. Load balancing aims to optimize resource use, maximize throughput, minimize response time, and avoid overload of any single resource. Using multiple components with load balancing instead of a single component may increase reliability and availability through redundancy. Load balancing usually involves dedicated software or hardware, such as a multilayer switch or a Domain Name System server process.</p>
</blockquote>
<p>中文版：</p>
<blockquote>
<p>负载平衡（Load balancing）是一种计算机网络技术，用来在多个计算机（计算机集群）、网络连接、CPU、磁盘驱动器或其他资源中分配负载，以达到最优化资源使用、最大化吞吐率、最小化响应时间、同时避免过载的目的。使用带有负载平衡的多个服务器组件，取代单一的组件，可以通过冗余提高可靠性。负载平衡服务通常是由专用软件和硬件来完成。</p>
</blockquote>
<p>上面的定义不仅包含了网络，还包含了计算的所有方面。操作系统、网络以及容器编排器等都有各自的负载均衡技术，用于使用各自的资源进行各自的任务调度。本文仅就网络负载均衡进行探讨。</p>
<p><img src="https://cdn-images-1.medium.com/max/1600/1*cCV-7Q-DDw87xNnTIVIhEg.png" alt="Network load balancing 概要"></p>
<blockquote>
<p>图 1：网络负载均衡概览</p>
</blockquote>
<p><strong>图 1</strong> 对网络负载均衡进行了一个高层次的概括。多个客户端向多个后端发起资源请求，负载均衡器处于客户端和后端之间，简单来说完成如下任务：</p>
<ul>
<li><strong>服务发现</strong>：系统中有哪些后端可用？这些后端的地址（也就是：负载均衡器如何同这些后端通信）？</li>
<li><strong>健康检查</strong>：哪些后端是健康的可以用于接收请求？</li>
<li><strong>负载均衡</strong>：用什么算法来把独立的请求分发给健康的后端？</li>
</ul>
<p>在分布式系统中合理的使用负载均衡能带来很多好处：</p>
<ul>
<li><strong>命名抽象</strong>：每个客户端不再需要知道每一个后端(服务发现)，客户端可以通过预定义的机制来找到负载均衡器，然后让负载均衡器完成命名解析功能。这些机制包括内置库，以及路人皆知的 DNS/IP/端口 地址，后面会深入讨论。</li>
<li><strong>错误隔离</strong>：通过健康检查以及一些其他的算法和技术，负载均衡器的路由方法能够有效的绕过瘫痪或过载的后端。这样运维人员在面对系统故障时，就可以更加从容的进行错误处理。</li>
<li><strong>成本和性能收益</strong>：分布式系统的网络的一致性比较差。系统通常要跨越多个网络区域。同一区域内，网络资源通常是低售的；而在跨区域的情况下，超售则是常态（超售和低售的鉴别，是通过网卡上可消耗的带宽和路由器之间的可用带宽进行比对得出的结论）。智能的负载均衡会尽可能保证通信在同一区域内进行，从而提高性能(降低延迟)并降低总体系统成本(降低区域间的带宽和光纤需求)。</li>
</ul>
<h3 id="负载均衡器-vs-代理服务器"><a href="#负载均衡器-vs-代理服务器" class="headerlink" title="负载均衡器 vs 代理服务器"></a>负载均衡器 vs 代理服务器</h3><p>业内谈到网络负载均衡器，<code>Load Balancer</code>以及<code>Proxy</code>这两个术语经常会同样对待，本文中也把这两个词条等价处理（卖弄一下：并非所有的代理都是负载均衡器，但是负载均衡是主流代理的首要功能）。</p>
<p>有人可能会问，有的负载均衡功能是作为客户端库的内置功能完成的，这种负载均衡器就不是代理服务器。这一话题本就容易混淆，这一质问更加让人混乱。文中会详述这种负载均衡器的拓扑，这种嵌入的负载均衡方式只是代理的一种特例，应用通过内嵌的库来完成代理职能，跟典型的负载均衡器的区别仅在于进程内外而已，其整体抽象是一致的。</p>
<h3 id="四层-连接-会话-负载均衡"><a href="#四层-连接-会话-负载均衡" class="headerlink" title="四层(连接/会话)负载均衡"></a>四层(连接/会话)负载均衡</h3><p>业界在讨论负载均衡技术的时候，经常会分为两类：L4 和 L7。这一分类来源于 <a href="https://en.wikipedia.org/wiki/OSI_model" target="_blank" rel="noopener">OSI 模型</a>的四层和七层的定义。OSI 模型无法很好的描述负载均衡方案中的复杂性，一个四层负载均衡在完成传统的四层协议任务例如 UDP 和 TCP 之外，往往还会加入了其他层次的内容。例如一个四层的 TCP 负载均衡还支持 TLS 功能，这算七层负载均衡了么？</p>
<p><img src="https://cdn-images-1.medium.com/max/1600/1*1PjTpM3hLnm3iEAd4-_AaQ.png" alt="4 层 TCP 负载均衡"></p>
<blockquote>
<p>图 2：TCP 终端四层负载均衡</p>
</blockquote>
<p><em><em>图 2 *</em> 展示了一个传统的四层 <a href="https://en.wikipedia.org/wiki/Transmission_Control_Protocol" target="_blank" rel="noopener">TCP</a> 负载均衡器。这个例子中，客户端向负载均衡器发起了一个 TCP 连接。负载均衡器 *终结</em> 了这一连接(也就是说直接响应了 SYN)，选择了一个后端，然后创建了到后端的新的 TCP 连接(就是发起了新的 SYN)。图中的细节不需太过关注，后面的四层负载均衡章节会进行详细讨论。</p>
<p>本节的关键点是四层负载均衡一般只在四层的 TCP/UDP 进行操作。笼统的说，负载均衡器负责操作这些字节，保证同一客会话的字节们只跟同一个后端打交道。四层负载均衡对通信中的应用细节是一无所知的。通信内容可以是 HTTP、Redis、MongoDB 或者任何应用协议。</p>
<h3 id="七层-应用-负载均衡"><a href="#七层-应用-负载均衡" class="headerlink" title="七层(应用)负载均衡"></a>七层(应用)负载均衡</h3><p>四层负载均衡很简单，目前还在大面积使用。四层负载均衡有什么短处，以至于需要七层(应用)负载均衡呢？例如下面几个四层的案例：</p>
<ul>
<li>两个 gRPC/HTTP2 客户端要连接到后端，所以通过四层负载均衡器来完成这一过程。</li>
<li>四层负载均衡器为每个接入的 TCP 连接创建一个外发的 TCP 连接，这样就有了两个接入、两个外发的连接。</li>
<li>然而客户端 A 的请求频率是每分钟 1 请求，而客户端 B 的频率是每秒钟 50 请求。</li>
</ul>
<p>在上述场景中，<em>为客户端 A 服务的后端，其负载水平仅相当于为客户端 B 服务的后端的约 1/3000 左右</em>，这明显违背了负载均衡器的初衷。在所有多工、保持连接的协议中都会发生这样的情况(多工意思是在单一四层连接中并行发送应用请求；保持连接则意味着在没有活动请求的情况下，也不会关闭连接)。出于性能方面的考虑(创建连接的成本通常较高，尤其是当使用 TLS 对连接进行加密的情况下)，所有的现代协议都包含这两个特性，所以随着时间的推移，四层负载均衡的负载不均的情况会越发明显。七层负载均衡能够解决这一问题。</p>
<p><img src="https://cdn-images-1.medium.com/max/1600/1*zsaxjSziEm1Tipr6kxs5Zg.png" alt="HTTP/2 七层负载均衡"></p>
<blockquote>
<p>图三：HTTP/2 七层终端负载均衡</p>
</blockquote>
<p><strong>图 3</strong> 描述了七层的 HTTP/2 负载均衡。这里客户端发起了对负载均衡的单个连接。负载均衡器连接到了两个后端。当客户端向负载均衡器发送两个 HTTP/2 流的时候，两个流会分别送往不同后端。这样多工客户端的大量不同的请求会被高效的分发给多个后端。这就是七层负载均衡对现代协议的重要性的来由（因为对应用流量的洞察能力，七层负载均衡还有很多其他好处，后面会详细描述）。</p>
<h3 id="七层负载均衡和-OSI-模型"><a href="#七层负载均衡和-OSI-模型" class="headerlink" title="七层负载均衡和 OSI 模型"></a>七层负载均衡和 OSI 模型</h3><p>之前四层负载均衡章节中说过，用 OSI 模型来描述负载均衡是有困难的。OSI 描述的第七层，涵盖了负载均衡的多方面功能的臭显。比如对 HTTP 来说，有以下几个低级一些的层次：</p>
<ul>
<li>可选的 TLS。网络界对 TLS 究竟应该属于 OSI 模型的哪一层素有争议。为讨论方便，我们放在七层。</li>
<li>物理的 HTTP 协议(HTTP/1或 HTTP/2)。</li>
<li>逻辑 HTTP 协议(Header、Body 和 Trailer)。</li>
<li>消息协议(gRPC、REST 等)。</li>
</ul>
<p>一个成熟的的七层负载均衡器应该照顾到上面描述的每一层次。另一个七层负载均衡器可能只支持七层分类中的特性的一个子集。总而言之，七层负载均衡器的范畴包含了远超四层的为数众多的功能（例子中只提到了了 HTTP；Redis、Kafka、MongoDB 等也都是七层应用协议的例子，也都应受益于七层负载均衡）。</p>
<h2 id="负载均衡器特性"><a href="#负载均衡器特性" class="headerlink" title="负载均衡器特性"></a>负载均衡器特性</h2><p>下面简单汇总一下负载均衡器的高层功能。并非所有负载均衡器都提供了所有功能。</p>
<h3 id="服务发现"><a href="#服务发现" class="headerlink" title="服务发现"></a>服务发现</h3><p>服务发现就是负载均衡器用于决定可用后台列表的过程。这一功能的实现方式花样百出，下面举一些例子：</p>
<ul>
<li>静态配置文件。</li>
<li>DNS。</li>
<li><a href="https://zookeeper.apache.org/" target="_blank" rel="noopener">Zookeeper</a>、<a href="https://coreos.com/etcd/" target="_blank" rel="noopener">Etcd</a>、<a href="https://www.consul.io/" target="_blank" rel="noopener">Consul</a> 等。</li>
<li>Envoy 的 <a href="https://medium.com/@mattklein123/the-universal-data-plane-api-d15cec7a" target="_blank" rel="noopener">统一数据平面 API</a>。</li>
</ul>
<h3 id="健康检查"><a href="#健康检查" class="headerlink" title="健康检查"></a>健康检查</h3><p>负载均衡器使用健康检查功能，来检测后端是否可用。健康检查有两种实现思路：</p>
<ul>
<li><strong>主动式</strong>：负载均衡器周期性的向后端发送 ping (例如一个发送到<code>/healthcheck</code>端点的 HTTP 请求)，以此判断后端的健康情况。</li>
<li><strong>被动式</strong>：负载均衡器通过对主数据流的分析来确定健康情况。比如一个四层负载均衡器，在发现连续三个连接错误的情况下，就会判定一个后端不可用；七层负载均衡可能会在连续三个 HTTP 503 响应之后判定这一后端为不健康状态。</li>
</ul>
<h3 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h3><p>是的负载均衡器必须为负载做均衡。有了一系列的健康后端，如何选择后端来响应一个请求或者连接呢？负载均衡算法是一个活跃的研究领域，有 Round Robin 这样的简单办法，也有通过延迟和后端负载情况进行判断的复杂方案。 <a href="https://brooker.co.za/blog/2012/01/17/two-random.html" target="_blank" rel="noopener">Power of 2 least request load balancing</a> 一文，介绍了最流行的兼顾性能和简易的负载均衡算法之一。</p>
<blockquote>
<p>随机选择两个后端，进一步选择其中负载较低的一个。</p>
</blockquote>
<h3 id="Session-粘连"><a href="#Session-粘连" class="headerlink" title="Session 粘连"></a>Session 粘连</h3><p>在某些应用中有一个重要需求：同一会话的请求需要到达同一后端。对于缓存、临时复杂状态等场景来说这是很必要的。对于“同一会话”的定义有多种形式，可能包括 HTTP Cookie、客户端连接的属性以及其他属性。很多七层负载均衡器具有一些对会话粘连的支持。然而我认为会话粘连是一种天然易碎的情况(处理会话的后端可能会瘫痪)，所以对于依赖会话的系统设计应该多加小心。</p>
<h3 id="TLS-终端"><a href="#TLS-终端" class="headerlink" title="TLS 终端"></a>TLS 终端</h3><p>TLS 这一话题，不管是边缘服务还是服务间通讯，都值得大书特书。因此很多七层负载均衡器在 TLS 处理方面都做了大量工作，其中包含终端、证书校验和绑定，使用 <a href="https://en.wikipedia.org/wiki/Server_Name_Indication" target="_blank" rel="noopener">SNI</a> 提供证书等功能。</p>
<h3 id="观测性"><a href="#观测性" class="headerlink" title="观测性"></a>观测性</h3><p>我常说：“观测性、观测性、观测性。”，网络是一个天生不可靠的东西，负载均衡器应该提供状态、跟踪以及日志，协助运维人员甄别故障，从而进行修复。负载均衡器的检测输出差距很大。高级的负载均衡器供应包含数字统计、分布式跟中和自定义日志的大量输出。我认为增强的观测性并不是从天而降的，负载均衡器需要做出很多附加工作来完成这一任务。对性能造成的负面影响，相对于这一系列数据的好处来说，不值一提。</p>
<h3 id="安全性和拒绝服务攻击防范"><a href="#安全性和拒绝服务攻击防范" class="headerlink" title="安全性和拒绝服务攻击防范"></a>安全性和拒绝服务攻击防范</h3><p>在边缘部署拓扑（后面会讲解）中，负载均衡器经常需要实现各种包含频率限制、认证以及 DoS 防范（例如 IP 地址的标记和辨识、<a href="https://en.wikipedia.org/wiki/Tarpit_%28networking%29" target="_blank" rel="noopener">Tarpitting</a>等方式）等在内的安全功能。</p>
<h3 id="配置和控制平面"><a href="#配置和控制平面" class="headerlink" title="配置和控制平面"></a>配置和控制平面</h3><p>负载均衡器应该是可配置的。在大规模部署中，这是一个重要的工作量。通常来说，用来配置负载均衡器的系统被称为“控制平面”，会有多种实现。拙作 <a href="https://medium.com/@mattklein123/service-mesh-data-plane-vs-control-plane-2774e720f7fc" target="_blank" rel="noopener">Service Mesh Data Plan vs Control Plan</a>  中对这一部分内容作了更深入的探讨。</p>
<h3 id="还有很多"><a href="#还有很多" class="headerlink" title="还有很多"></a>还有很多</h3><p>这部分只是对于负载均衡器的功能层面作了一些介绍。下面还会在七层负载均衡器方面做更多的深入讨论。</p>
<h2 id="负载均衡器的拓扑分类"><a href="#负载均衡器的拓扑分类" class="headerlink" title="负载均衡器的拓扑分类"></a>负载均衡器的拓扑分类</h2><p>我们已经对负载均衡器的概念作了一些概括的介绍，四层和七层负载均衡器的区别，以及负载均衡器特性的汇总，接下来我们会针对分布式系统中的负载均衡器部署拓扑进行一些探讨（下面的每一种拓扑都是适用于四层和七层负载均衡器的）。</p>
<h3 id="中间代理"><a href="#中间代理" class="headerlink" title="中间代理"></a>中间代理</h3><p><img src="https://cdn-images-1.medium.com/max/1600/1*cCV-7Q-DDw87xNnTIVIhEg.png" alt="Middle proxy"></p>
<blockquote>
<p>图 4：中间代理负载均衡拓扑</p>
</blockquote>
<p><strong>图 4</strong> 描述的这种拓扑对多数读者来说都是最熟悉的。这一类别包括了 Cisco、Juniper、F5 等硬件产品；云软件解决方案例如 Amazone 的 <a href="https://aws.amazon.com/elasticloadbalancing/" target="_blank" rel="noopener">ALB 和 NLB</a> 以及 Google 的 <a href="https://cloud.google.com/load-balancing/" target="_blank" rel="noopener">Cloud Load Balancer</a>，还有 <a href="https://www.haproxy.com/" target="_blank" rel="noopener">HAProxy</a>、<a href="https://www.nginx.com/" target="_blank" rel="noopener">NGINX</a> 以及 <a href="https://www.envoyproxy.io/" target="_blank" rel="noopener">Envoy</a> 这样的纯软件自主方案。中间代理方案的优势在于对用户提供的简便性。一般情况下用户只要通过 DNS 连接到负载均衡器即可，无需担心其他情况；弱势在于，负载均衡器存在单点失败的风险，同时也是可能的性能瓶颈。中间代理通常是一个不便运维的黑盒子。问题出现在哪里？是客户端还是物理网络？是中间代理还是后端？很难鉴定。</p>
<h3 id="边缘代理"><a href="#边缘代理" class="headerlink" title="边缘代理"></a>边缘代理</h3><p><img src="https://cdn-images-1.medium.com/max/1600/1*4zSWjsKnaC6QQmJ7PTj7Eg.png" alt="Edge proxy"></p>
<blockquote>
<p>图 5：边缘代理负载均衡拓扑</p>
</blockquote>
<p><strong>图 5</strong> 实际上是中间代理的一种变体，这种负载均衡器可以通过 Internet 进行访问。在这一场景下，负载均衡器通常需要提供一些附加的 “API 网关”类功能，例如 TLS 终端、频率限制、认证以及流量路由等。优势和劣势跟中间服代理类似。在一个大的面向 Internet 的分布式系统中，边缘服务器通常是一个必要的组成部分。客户端通常会使用某个不受服务提供商控制的网络库，通过 DNS 来访问这一系统(后面将会讨论的嵌入客户库或者 Sidecar 代理拓扑都不适合直接运行在客户端)。另外为了安全方面的考虑，为所有的面向 Internet 的流量使用单一的网关来提供入站流量是一个普遍要求。</p>
<h3 id="嵌入式客户库"><a href="#嵌入式客户库" class="headerlink" title="嵌入式客户库"></a>嵌入式客户库</h3><p><img src="https://cdn-images-1.medium.com/max/1600/1*nuqZiYoFEkDe2cUgMh0aQw.png" alt="Embedded  client library"></p>
<blockquote>
<p>图 6：通过嵌入客户端库实现负载均衡</p>
</blockquote>
<p>为了克服随中间代理而出现的单点失败以及性能问题，很多成熟架构把负载均衡直接植入如<strong>图 6</strong> 所示的客户端库中。不同的库所支持的功能差别很大，此类产品中最知名的功能丰富的包括 <a href="https://twitter.github.io/finagle/" target="_blank" rel="noopener">Finagle</a>、<a href="https://netflix.github.io/" target="_blank" rel="noopener">Eureka/Ribbon/Hystrix</a> 以及 <a href="https://grpc.io/" target="_blank" rel="noopener">gRPC</a>（大致基于 Google 的一个称为 Stubby 的内部系统）。这种方式的好处是把所有负载均衡特性完全分布到每个客户端，从而避免了前面说到的单点失败和性能瓶颈。这种做法的弱势也很明显，一个组织使用的所有语言，都需要实现这种客户端库。分布式架构下，这种多语言支持的要求会越来越多。这种环境里，每种语言的网络库实现造成的成本会让人望而却步。最后，在大的服务架构中进行库升级也是一个很大的挑战，而在生产环境中并行运行不同的版本，又会给运维造成更大压力。</p>
<p>结合上面的优劣势分析，可以知道，在能够限制编程语言使用，并克服升级痛苦的情况下，这种架构是可以获得成功的。</p>
<h3 id="Sidecar-代理"><a href="#Sidecar-代理" class="headerlink" title="Sidecar 代理"></a>Sidecar 代理</h3><p><img src="https://cdn-images-1.medium.com/max/1600/1*wPoZoz6cKAo0HBi1wmNZtA.png" alt="Sidecar Proxy"></p>
<blockquote>
<p>图 7：Sidecar 代理实现负载均衡</p>
</blockquote>
<p>嵌入式客户库的一个变体就是<strong>图 7</strong> 中的 Sidecar 代理拓扑。近年来，这一拓扑以 “Service Mesh” 的概念日益流行。Sidecar 代理背后的思路是，以进程间通信造成的些许延迟为代价，在无需顾虑编程语言锁定的情况下获得嵌入客户端库的各种优点。目前流行的 Sidecar 负载均衡包括 <a href="https://www.envoyproxy.io/" target="_blank" rel="noopener">Envoy</a>、<a href="https://www.nginx.com/" target="_blank" rel="noopener">NGINX</a>、<a href="https://www.haproxy.com/" target="_blank" rel="noopener">HAProxy</a> 以及 <a href="https://linkerd.io/" target="_blank" rel="noopener">Linkerd</a>，我的两篇文章：<a href="https://eng.lyft.com/announcing-envoy-c-l7-proxy-and-communication-bus-92520b6c8191" target="_blank" rel="noopener">Introducing Envoy</a> 和  <a href="https://medium.com/@mattklein123/service-mesh-data-plane-vs-control-plane-2774e720f7fc" target="_blank" rel="noopener">Service Mesh Data Plan vs Control Plan</a> 对这种结构进行了更细致的描写。</p>
<h3 id="不同负载均衡器拓扑的总结和优劣势"><a href="#不同负载均衡器拓扑的总结和优劣势" class="headerlink" title="不同负载均衡器拓扑的总结和优劣势"></a>不同负载均衡器拓扑的总结和优劣势</h3><ul>
<li>中间代理拓扑是最简单的最典型的方式。他的弱点在于：故障单点、伸缩瓶颈以及黑箱操作。</li>
<li>边缘代理拓扑和中间代理类似，通常无法忽略。</li>
<li>嵌入客户端库的方式提供了最好的性能和伸缩性，不过面向多种语言的开发，和升级所有服务的库都是很大的挑战。</li>
<li>Sidecar 代理拓扑比嵌入式客户端库要弱，但也避免了这种方式的两大难点。</li>
</ul>
<p>总的来说，我认为在服务对服务的情况下， sidecar 代理拓扑(Service Mesh)会逐渐代替所有其他拓扑形式。为了处理进入 Service Mesh 之前的流量，边缘代理拓扑会长期存在。</p>
<h2 id="四层负载均衡的现状"><a href="#四层负载均衡的现状" class="headerlink" title="四层负载均衡的现状"></a>四层负载均衡的现状</h2><h3 id="四层负载均衡器还有用么？"><a href="#四层负载均衡器还有用么？" class="headerlink" title="四层负载均衡器还有用么？"></a>四层负载均衡器还有用么？</h3><p>本文已经谈论了很多七层负载均衡器对现代协议的好处，后面还会谈到七层负载均衡的功能细节。这是否意味着四层负载均衡器无需存在了？不是的。虽然我认为最终七层负载均衡会完全在<em>服务对服务</em>的场景中取代四层负载均衡器，但四层负载均衡器对边缘通信还是非常有意义的，这是因为所有现代的大型分布式架构都是用了两层的四层/七层负载均衡架构来处理互联网流量。在七层负载均衡器之前部署独立的四层负载均衡器的好处是：</p>
<ul>
<li>七层负载均衡器要在应用层面进行更多的精密分析、变换以及路由工作，对于原始流量（每秒数据包或每秒字节数）的负载，其能力要弱与优化过的四层负载均衡器。这一现实让四层负载均衡器成为更好的应对拒绝服务攻击（例如 SYN flood、通用包 flood 攻击等）的位置。</li>
<li>相对于四层负载均衡器，七层负载均衡器的开发更加活跃，部署更加频繁，也会有更多 Bug。有了前置的四层负载均衡器，就可以在七层负载均衡器升级期间进行健康检查和排空，现代四层负载均衡器通常使用 BGP 和 ECMP(后续章节会详细讲解)，七层负载均衡的部署通常会较为简单。最后因为七层负载均衡器相对来说复杂度较高，因此也更容易出现问题，有了前端的四层负载均衡，就可以在出现问题的时候利用路由功能绕过故障节点，提高系统的总体稳定性。</li>
</ul>
<p>下文中我会降到集中不同设计的中间/边缘四层负载均衡器。后面提到的设计通常是无法用在客户库或 Sidecar 拓扑中的。</p>
<h3 id="TCP-UDP-终端负载均衡器"><a href="#TCP-UDP-终端负载均衡器" class="headerlink" title="TCP/UDP 终端负载均衡器"></a>TCP/UDP 终端负载均衡器</h3><p><img src="https://cdn-images-1.medium.com/max/1600/1*1PjTpM3hLnm3iEAd4-_AaQ.png" alt="四层终端负载均衡器"></p>
<blockquote>
<p>图 8：四层终端负载均衡器</p>
</blockquote>
<p>还在应用的第一种四层负载均衡器是<strong>图 8</strong>中的终端负载均衡器。这和我们介绍四层负载均衡的时候讲到的内容是一致的。这种类型的负载均衡器中，使用了两个的独立的 TCP 连接：一个用于客户端和负载均衡器之间；另一个用在负载均衡器和后端之间。</p>
<p>四层终端负载均衡器还有两个原因：</p>
<ol>
<li>实现相对简单。</li>
<li>靠近客户端的连接终端对性能有显著影响。尤其是如果客户使用有损网络(例如蜂窝网)的话，在进入稳定的有线传输到最终目的之前，是容易发生重传的。换句话说，这种负载均衡器适用于在存在点(Point of Presence )场景下的原始 TCP 连接。</li>
</ol>
<h3 id="TCP-UDP-透传负载均衡器"><a href="#TCP-UDP-透传负载均衡器" class="headerlink" title="TCP/UDP 透传负载均衡器"></a>TCP/UDP 透传负载均衡器</h3><p><img src="https://cdn-images-1.medium.com/max/1600/1*mf0S8BrWjxSBU-mP4ZpC9A.png" alt="四层透传负载均衡器"></p>
<blockquote>
<p>图 9：</p>
</blockquote>
<p>四层负载均衡器的另一种类型就是<strong>图 9</strong>所说的透传负载均衡器。这种类型的负载均衡过程中，TCP连接没有被负载均衡器终结，每个链接的数据包，在经过连接分析和网络地址转换(NAT)过程之后，都被转发给一个选中的后端。首先让我们定义一下连接跟踪和 NAT：</p>
<ul>
<li><strong>连接跟踪</strong>：跟踪全部活动 TCP 连接的过程。这里包括很多内容，例如握手是否完成，是否收到 FIN，连接发呆了多久，这个连接转发给哪一个后端等。</li>
<li><strong>NAT</strong>：是使用连接跟踪数据，来更改数据包的 IP/端口信息使之穿过负载均衡器的过程。</li>
</ul>
<p>有了连接跟踪和 NAT，负载均衡器就能把客户端的 TCP 流量几乎原封不动的的转发给后端。例如客户端同<code>1.2.3.4:80</code>进行通信，选中的后端是<code>10.0.0.2:9000</code>。客户端的 TCP 数据包会到达位于<code>1.2.3.4:80</code>的负载均衡器。负载均衡器会把目标 IP 和端口替换为<code>10.0.0.2:9000</code> ；同时还会把源 IP 替换为负载均衡器的 IP。当后端响应 TCP 连接时，数据包就会返回给负载均衡器，负载均衡器中的链接跟踪和 NAT 再次发挥作用，反向送回数据包。</p>
<p>为什么会使用这一种负载均衡器，而不是前面提到的终端型呢？</p>
<ul>
<li><strong>性能和资源消耗</strong>：透传型的负载均衡器没有终结 TCP 连接，无需缓存任何的 TCP 连接窗口。每个连接的状态存储非常小，通常使用高效的哈希表查询即可。正因如此，相对终端负载均衡器来说，透传型负载均衡器能够处理更大数量的活动链接，单位时间内处理更多的数据包。</li>
<li><strong>允许后端进行拥塞控制</strong>：<a href="https://en.wikipedia.org/wiki/TCP_congestion_control" target="_blank" rel="noopener">TCP 拥塞控制</a> 是一种机制，让 Internete 端点对外发数据进行流量控制，防止超量使用带宽和缓冲。</li>
<li><strong>为直接服务器返回（Direct Server Return = DSR）做基线，以及四层负载均衡集群</strong>：透传负载均衡也是高级四层负载均衡（例如后面将要说到的 DSR 和使用分布式一致性哈希的集群）的基础。</li>
</ul>
<h3 id="Direct-Server-Return-DSR"><a href="#Direct-Server-Return-DSR" class="headerlink" title="Direct Server Return (DSR)"></a>Direct Server Return (DSR)</h3><p><img src="https://cdn-images-1.medium.com/max/1600/1*4IW2Y8SvovEMrWpuZA-mtg.png" alt="四层 DSR"></p>
<blockquote>
<p>图 10：四层 DSR</p>
</blockquote>
<p><strong>图 10</strong>展示的就是 DSR 负载均衡。DSR 构建在前文提到的透传负载均衡器的基础之上。DSR 是一种优化方案，只有<code>入站/请求</code>数据包通过负载均衡；<code>出站/响应</code>数据包绕过负载均衡器直接返回给客户端。使用 DSR 方案的有趣之处在于，很多负载的响应比请求数据量大很多(比如典型的 HTTP 请求和响应)。假设 10% 的流量是请求，另外 90% 是响应，如果使用了 DSR 负载均衡，仅需要 1/10 的容量就能够满足系统需要。从前的负载均衡非常昂贵，这一方案能够显著降低系统成本并提高可靠性(更少就是更好)。DSR 负载均衡器用下面的方式扩展了透传负载均衡的概念：</p>
<ul>
<li>由于响应包不再经过负载均衡器，所以连接跟踪仅有部分数据，负载均衡器无法知道完整的 TCP 连接状态。然而还是可以通过对客户数据包的观察，对发呆超时的情况来推断具体状态。</li>
<li>负载均衡器通常使用 GRE 来封装 IP 包，并从负载均衡器发送到后端。这样当后端接收到封装后的数据包，可以解包并获得客户端的端口和地址。这样后端就能直接跨过负载均衡器直接发送响应包给客户端了。</li>
<li>DSR 负载均衡器的一个重要部分就是：后端部分的参与了负载均衡过程。后端需要合理的配置 GRE 隧道，并且需要根据网络的低级细节来配置自己的连接跟踪以及 NAT 等。</li>
</ul>
<p>注意不管是 DSR 还是透传负载均衡器，其中的连接跟踪、NAT、GRE 等组成部分都有很多不同设计方式。这些设置从负载均衡器到后端都会涉及。这部分内容超出了本文的范围，就不再深入进行了。</p>
<h3 id="使用高可用配对方式实现容错"><a href="#使用高可用配对方式实现容错" class="headerlink" title="使用高可用配对方式实现容错"></a>使用高可用配对方式实现容错</h3><p><img src="https://cdn-images-1.medium.com/max/1600/1*q5ZtVZb4UhzuGyhIa5lARA.png" alt="四层负载均衡器的容错和伸缩"></p>
<blockquote>
<p>图 11：使用 HA 对和连接跟踪实现容错</p>
</blockquote>
<p>到现在，我们要考虑四层负载均衡的容错设计了。不管是 DSR 还是透传负载均衡都需要一定数量的链接跟踪和状态数据存储在负载均衡器中。负载均衡器宕机了会怎样？——所有经过这一负载均衡器的连接都会断掉。可能对应用产生显著影响。</p>
<p>历史上，四层负载均衡器是一种从典型供应商（Cisco、Juniper、F5 等）采购的硬件。这些设备非常昂贵，能够处理大量通信。为了防止单点失败导致的所有连接中断，引发应用故障，负载均衡器通常会使用高可用配对的方式进行部署，如<strong>图 11</strong> 所示。典型的高可用负载均衡器配置会满足如下设计：</p>
<ul>
<li>一对高可用边缘路由器提供一系列的虚拟 IP(VIP)。这些边缘路由器使用边界网关协议(BGP)来发布虚拟 IP。主要边缘路由器的 BGP 优先级高于备用边缘路由器，所以正常情况下他会处理所有流量(BGP 是一个超级复杂的协议；为了行文方便，可以理解 BGP 是一种机制，这种机制让网络设备可以宣称自身能够处理来自其他网络设备的流量，并且每个连接都会有一个权重，从而影响连接的通信)。</li>
<li>类似的，主要四层负载均衡向 BGP 权重较高的边缘路由器宣告可用，所以在通常情况下，他会处理所有流量。</li>
<li>两个边缘路由器和两个负载均衡器是交叉连接的，这意味着如果一个边缘路由器或者一个负载均衡器宕机，或者因为某些原因 BGP 宣布失效，备用设备就会接入，承载所有流量。</li>
</ul>
<p>上面的设置是目前很多互联网上的高流量应用还在持续使用的方式，但是这种方案有一些副作用：</p>
<ul>
<li>VIP 必须通过高可用负载均衡器对流量进行正确的分配。如果单一 VIP 的容量超过了 HA 对，则 VIP 需要分割为多个 VIP。</li>
<li>系统资源使用率很低。通常会有一半的容量在闲置。过去的负载均衡器非常昂贵，所以这一闲置成本也是很高的。</li>
<li>现代分布式系统设计要求比主备模式更好的容错设计。例如一个系统需要在多个同时出现故障的情况下保持运行。高可用负载均衡对如果遭遇同时故障，就会导致完全瘫痪。</li>
<li>供应商提供的硬件设备价格昂贵，会导致对特定厂商的依赖。使用支持水平扩展的软件方案对商业硬件设施进行替换，是目前普遍存在的迫切需要。</li>
</ul>
<h3 id="使用分布式一致性哈希进行容错和伸缩"><a href="#使用分布式一致性哈希进行容错和伸缩" class="headerlink" title="使用分布式一致性哈希进行容错和伸缩"></a>使用分布式一致性哈希进行容错和伸缩</h3><p><img src="https://cdn-images-1.medium.com/max/1600/1*q5ZtVZb4UhzuGyhIa5lARA.png" alt="Figure 12"></p>
<blockquote>
<p>图 12：四层负载均衡器和一致哈希实现容错和伸缩</p>
</blockquote>
<p>前文介绍了通过高可用配对的方式来进行负载均衡器的容错设置，以及随之而来的问题。千禧年初，一些大的互联网基础设施提供商开始设计和部署新的<strong>图 12</strong>模式的并行四层负载均衡系统。这类系统的目标是：</p>
<ul>
<li>解决使用成对 HA 模式设计的负载均衡方案带来的所有问题。</li>
<li>从厂商专属的专利硬件模式的负载均衡器中迁移出来，使用标准服务器和网卡配合商业软件方案进行替代。</li>
</ul>
<p>四层负载均衡器的设计是 <strong>fault tolerance and scaling via clustering and distributed consistent hashing</strong> 的最佳引用，具体工作模式是：</p>
<ul>
<li>N 个边缘路由器在同一 BGP 权重上，声明所有的 <a href="https://en.wikipedia.org/wiki/Anycast" target="_blank" rel="noopener">任播</a> VIP。使用 <a href="https://en.wikipedia.org/wiki/Equal-cost_multi-path_routing" target="_blank" rel="noopener">ECMP(等价多路径路由)</a> 来保证所有单一 Flow 能够到达同一个边缘路由器。一个 Flow 通常是一个由源 IP/端口和目的 IP/端口 构成的元组。(简单说，ECMP 是一个在使用一致性哈希连接的独立加权网络上分发数据包的方式)。边缘路由器并不在意哪些数据包去了哪里。一般会倾向于把来自于一个 Flow 所有数据包发送给同一套连接，以此避免乱序包导致的性能损失。</li>
<li>N 个四层负载均衡器向边缘路由器在同一个 BGP 权重上声明所有的 VIP。再次借助 ECMP，边缘路由器会选择为同一个 Flow 选择同一个负载均衡器。</li>
<li>每个四层负载均衡器会进行部分的连接跟踪，为这一 Flow 使用<a href="https://en.wikipedia.org/wiki/Consistent_hashing" target="_blank" rel="noopener">一致性哈希</a>选择一个后端。从负载均衡器到后端的数据包会使用 GRE 进行封装。</li>
<li>接下来使用 DSR 将相应包直接从后端通过边缘路由器发送会客户端。</li>
<li>四层负载均衡器使用的一致性哈希算法是一个活跃的研究领域，其中涉及合理分配、减小延迟、后端变更成本以及最小化内存开支等各方面要素。这方面的完整讨论也超出了本文范围。</li>
</ul>
<p>接下来看看这种设计如何克服 HA 配对方式的缺点：</p>
<ul>
<li>新的边缘路由器和负载均衡器可以按需加入。一致性哈希会在各个层次上使用，在加入新机器的时候，尽可能降低受影响的 Flow 数量。</li>
<li>在保持对突发消耗的支持能力以及容错能力的同时，可以提高资源的使用率。</li>
<li>边缘路由器和负载均衡都可以使用使用普通硬件，仅是传统硬件负载均衡成本的几分之一（下文会进一步说明）。</li>
</ul>
<p>行文至此，有读者可能会问：“为什么不让边缘路由器直接通过 ECMP 和后端进行通信？为什么我们还需要负载均衡器？”。答案是 DoS 防范以及后端运维难度。如果没有负载均衡器支持，每个后端都需要加入 BGP，而且难于进行滚动更新。</p>
<p>所有的现代四层负载均衡系统都在向着这一方案（或其变体）迁移。两个最为公众所知的例子就是 Google 的 <a href="https://research.google.com/pubs/pub44824.html" target="_blank" rel="noopener">Maglev</a> 以及 Amazon 的 <a href="http://docs.aws.amazon.com/elasticloadbalancing/latest/network/introduction.html" target="_blank" rel="noopener">Network Load Balancer (NLB)</a>。目前还没有任何开源负载均衡器实现了这一设计，然而据我所知，有公司要在 2018 年发布一个这样的产品。我很期待他的出现，这一产品将会填补开源网络组件的重要空白。</p>
<h2 id="当前七层负载均衡的技术状态"><a href="#当前七层负载均衡的技术状态" class="headerlink" title="当前七层负载均衡的技术状态"></a>当前七层负载均衡的技术状态</h2><pre><code>Current state of the art in L7 load balancing

The proxy wars in tech currently is *quite literally* the proxy wars.

Or the &quot;war of the proxies&quot;.

Nginx plus, HAProxy, linkerd, Envoy all quite literally killing it. 

And proxy-as-a-service/routing-as-a-service SaaS vendors raising the bar as well. Very interesting times!</code></pre><p>是的，的确是这样。近几年我们看到七层负载均衡/代理技术的开发工作开始复兴。随着分布式微服务系统的不断推进，这方面也会不断进步。从基础上看，目前对于靠不住的网络的依赖越发严重，带来更高的运维难度。从长远看，自动伸缩、容器编排等技术的大量使用，意味着静态 IP、静态文件的时代已经过去了。系统不仅更多的使用网络，而且更加动态，需要新的负载均衡功能。在本节中我们简单归纳一下现在七层负载均衡器的功能。</p>
<h3 id="协议支持"><a href="#协议支持" class="headerlink" title="协议支持"></a>协议支持</h3><p>现代七层负载均衡器加入了很多不同协议的显式支持。负载均衡器对应用通讯认识越多，就越能做好监控输出、高级负载均衡和路由等功能。例如目前 Envoy 显式的支持七层协议解析和路由的范围包括 HTTP/1、HTTP/2、gRPC、Redis、MongoDB 以及 DynamoDB。包括 MySQL 和 Kafka 在内的更多协议会逐渐添加进来。</p>
<h3 id="动态配置"><a href="#动态配置" class="headerlink" title="动态配置"></a>动态配置</h3><p>如上文所述，分布式系统的大行其道，需要有动态配置能力来提高系统的动态和控制能力。<a href="https://istio.io/" target="_blank" rel="noopener">Istio</a>就是一个这种系统的例子。请参考 <a href="https://medium.com/@mattklein123/service-mesh-data-plane-vs-control-plane-2774e720f7fc" target="_blank" rel="noopener">Service Mesh Data Plan vs Control Plan</a> 来获取更多这方面的内容。</p>
<h3 id="高级负载均衡"><a href="#高级负载均衡" class="headerlink" title="高级负载均衡"></a>高级负载均衡</h3><p>七层负载均衡器一般都有内置的高级负载均衡支持，例如超时、重试、频率控制、断路器、Shadow、缓冲、基于内容的路由等。</p>
<h3 id="可观测性"><a href="#可观测性" class="headerlink" title="可观测性"></a>可观测性</h3><p>上文中也提到过，负载均衡的一个常见功能，越来越多的动态系统被部署，调试难度也水涨船高。健壮的协议规范观测输出可能是未来七层负载均衡器要提供的最重要功能之一。统计数字、分布式跟踪以及可以定义日志的输出，目前已经成为对器层负载均衡解决方案的必须要求。</p>
<h3 id="扩展性"><a href="#扩展性" class="headerlink" title="扩展性"></a>扩展性</h3><p>现代七层负载均衡器需要能够简单的加入定制功能。这一功能可以通过编写可插接过滤器，并载入到负载均衡器的方式来实现。很多负载均衡器还支持脚本扩展，例如 <a href="https://www.lua.org/" target="_blank" rel="noopener">Lua</a>。</p>
<h3 id="容错"><a href="#容错" class="headerlink" title="容错"></a>容错</h3><p>在讲四层负载均衡的容错时颇费了一番口舌。七层负载均衡的容错又怎样呢？一般来说我们认为七层负载均衡器（的工作负载）是无状态的可抛弃的。使用普通软件就能够简单的对七层负载均衡器进行水平扩展。另外器层负载均衡的流量处理和状态跟踪的复杂度要远超四层。设置七层负载均衡器的 HA 配对在技术上是可行的，但会非常繁杂。</p>
<p>总的说来，不管是四层还是七层的负载均衡，业界都在尝试走出 HA 配对模式，转向一致性哈希为基础的水平扩展方式。</p>
<h3 id="更多"><a href="#更多" class="headerlink" title="更多"></a>更多</h3><p>七层负载均衡器正在高速发展。可以参考 <a href="https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/arch_overview" target="_blank" rel="noopener">Envoy 架构概览</a>。</p>
<h2 id="全局负载均衡和中心控制平面"><a href="#全局负载均衡和中心控制平面" class="headerlink" title="全局负载均衡和中心控制平面"></a>全局负载均衡和中心控制平面</h2><p><img src="https://cdn-images-1.medium.com/max/1600/1*WMjv7B0UzZgJje_uQPtvtg.png" alt="Global load balancing"></p>
<blockquote>
<p>图 13：全局负载均衡</p>
</blockquote>
<p>未来会有越来越多的独立负载均衡器以商品设备的面目呈现。我认为真正的创新和商业机会来自于控制平面。<strong>图 13</strong>展示了一个全局负载均衡系统。在本例中有一些不同的东西：</p>
<ul>
<li>每个 Sidecar 代理和三个不同区域的后端进行通信。</li>
<li>如图，90% 的流量会被发送到 C 区，A B 两区分别得到 5%。</li>
<li>Sidecar 代理和后端都会周期性的向全局负载均衡器进行汇报。这样全局负载均衡器就可以根据延迟、成本、负载、失败率等数据进行精密决策。</li>
<li>全局负载均衡周期性的使用当前的路由信息配置每个 Sidecar 代理。</li>
</ul>
<p>全局负载均衡能做一些单一负载均衡器做不到的事情，例如：</p>
<ul>
<li>对分区故障的自动检测和路由绕行。</li>
<li>应用全局的安全和路由策略。</li>
<li>使用机器学习和神经网络，对异常流量进行检测和防范，包括分布式拒绝服务攻击。</li>
<li>提供中央界面和可视化支持，让工程师能够以聚合的角度，对整个分布式系统进行监控和运维。</li>
</ul>
<p>全局负载均衡器要成为现实，他的数据平面必须具有强大的动态配置能力。请参考我的博客：<a href="https://medium.com/@mattklein123/the-universal-data-plane-api-d15cec7a" target="_blank" rel="noopener">Envoy’s universal data plane API</a>，以及  <a href="https://medium.com/@mattklein123/service-mesh-data-plane-vs-control-plane-2774e720f7fc" target="_blank" rel="noopener">Service Mesh Data Plan vs Control Plan</a> 。</p>
<h2 id="从硬件到软件的变革"><a href="#从硬件到软件的变革" class="headerlink" title="从硬件到软件的变革"></a>从硬件到软件的变革</h2><p>这里只是简要的提到了硬件和软件的问题，主要聚焦在四层负载均衡高可用方面的历史问题。这一领域的业界趋势又如何呢？</p>
<p><img src="./new-osi.png" alt="New OSI"></p>
<p>这一推虽说略显浮夸，但却很好的描述了技术趋势：</p>
<ul>
<li>历史上的负载均衡器和路由器都曾经是昂贵的专属硬件</li>
<li>逐渐的，多数三层四层网络设备都被替换为通用服务器硬件和网卡，以及基于 <a href="http://www.linuxvirtualserver.org/software/ipvs.html" target="_blank" rel="noopener">IPVS</a>、<a href="http://dpdk.org/" target="_blank" rel="noopener">DPDK</a> 和 <a href="https://fd.io/" target="_blank" rel="noopener">fd.io</a>之类的框架的特定软件方案。一个现代的成本低于 $5k 的数据中心，运行 Linux 和自定义的基于 DPDK 的 user-space 应用，能够轻松用超小数据包跑满 80Gbps 的网络。另外廉价的基于 ASICs 的基础路由器/交换机也能够完成 ECMP 路由工作，并能支撑和通用路由器同级别的带宽和包速率。</li>
<li>Nginx、HAProxy 以及 Envoy 这样的七层软负载均衡，也正快速发展，逐步进入过去由 F5 这样的厂商的专属领域。此外，七层负载均衡器正激进的向通用软件方案的方向迈进。</li>
<li>同时，主要云提供商推动的 IaaS、CaaS 以及 FaaS 潮流，使得只有一小部分人需要理解物理网络(这属于黑科技，以及“我们不再需要深入了解”的范围了)。</li>
</ul>
<h2 id="结论，以及负载均衡器的未来"><a href="#结论，以及负载均衡器的未来" class="headerlink" title="结论，以及负载均衡器的未来"></a>结论，以及负载均衡器的未来</h2><p>综上所述，本文的主旨：</p>
<ul>
<li>负载均衡器是现代分布式系统的关键组件。</li>
<li>有两种负载均衡器：四层和七层。</li>
<li>四层和七层负载均衡器都与现代架构相关。</li>
<li>四层负载均衡器正在朝着基于一致性哈希的水平扩展方案的方向进行迁移。</li>
<li>由于动态微服务架构的成长，七层负载均衡器得以快速发展。</li>
<li>控制平面和数据平面的拆分，和全局负载均衡，是负载均衡的未来发展方向和机会来源。</li>
<li>业界正激进的迈向标准硬件和软件的开源解决方案。我相信传统的像 F5 这样的负载均衡厂商会被开源软件和云供应商取代。传统的路由器、交换机厂商，例如 Arista/Cumulus 等，短期内会有更好的发展，但最终也会被共有云提供商及其自研物理网络所取代。</li>
</ul>
<p>总的说来，我认为这是计算器网络的奇迹年代。多数系统开始向开源和软件方向转变，极大的提高了迭代速度。未来，分布式系统又向无服务器计算进军，底层网络和负载均衡系统的复杂性也势必齐头并进，水涨船高。</p>

            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://www.asxing.com" rel="external nofollow noreferrer">HoldDie</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://www.asxing.com/2018/01/31/xian-dai-fu-zai-jun-heng-he-dai-li-ji-zhu-jian-jie/">https://www.asxing.com/2018/01/31/xian-dai-fu-zai-jun-heng-he-dai-li-ji-zhu-jian-jie/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="https://www.asxing.com" target="_blank">HoldDie</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/">
                                    <span class="chip bg-color">负载均衡</span>
                                </a>
                            
                                <a href="/tags/%E4%BB%A3%E7%90%86/">
                                    <span class="chip bg-color">代理</span>
                                </a>
                            
                                <a href="/tags/LV4/">
                                    <span class="chip bg-color">LV4</span>
                                </a>
                            
                                <a href="/tags/LV7/">
                                    <span class="chip bg-color">LV7</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
            
        </div>
    </div>

    
        <link rel="stylesheet" href="/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: 'c4e18e113d94091c8828',
        clientSecret: '891f04d80de6a77fd6eb60d1cbe792e916cde3ff',
        repo: 'asxing.github.io',
        owner: 'Asxing',
        admin: "asxing",
        id: '2018-01-31T21-32-16',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>
    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2018/02/01/ecache-fen-bu-shi-huan-cun/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/8.jpg" class="responsive-img" alt="ehcache分布式缓存">
                        
                        <span class="card-title">ehcache分布式缓存</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            Nginx+ Ehcache + Tomcat 集群实现 Ehcache 缓存共享
环境信息


主机
端口
开源软件



10.10.3.83
80
Nginx(1.12.2)


10.15.0.174
10080
Tomcat(8.
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2018-02-01
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E7%BC%93%E5%AD%98/" class="post-category">
                                    缓存
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Ehcache/">
                        <span class="chip bg-color">Ehcache</span>
                    </a>
                    
                    <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/">
                        <span class="chip bg-color">分布式</span>
                    </a>
                    
                    <a href="/tags/%E7%BC%93%E5%AD%98/">
                        <span class="chip bg-color">缓存</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2018/01/27/shi-jian-qu-dong-yi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/18.jpg" class="responsive-img" alt="微服务之事件驱动（一）">
                        
                        <span class="card-title">微服务之事件驱动（一）</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            在微服务架构中解决分布式数据管理微服务可以帮助企业更快迭代产品超越竞争对手，但是其中有一个挑战就是分布式数据管理，每一个微服务都有自己的数据库，尤其是在跨多个服务之后保持业务事务的一致性以及复杂的检索查询是十分困难的。解决方案Eventua
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2018-01-27
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8/" class="post-category">
                                    事件驱动
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">
                        <span class="chip bg-color">微服务</span>
                    </a>
                    
                    <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/">
                        <span class="chip bg-color">分布式</span>
                    </a>
                    
                    <a href="/tags/DDD/">
                        <span class="chip bg-color">DDD</span>
                    </a>
                    
                    <a href="/tags/EventSourcing/">
                        <span class="chip bg-color">EventSourcing</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>

    
<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>

    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>


<script src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
    MathJax.Hub.Config({
        tex2jax: {inlineMath: [['$', '$'], ['\(', '\)']]}
    });
</script>


    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">年份</span>
            <a href="https://www.asxing.com" target="_blank">Asxing</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">479k</span>&nbsp;字
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <span id="sitetime">载入运行时间...</span>
            <script>
                function siteTime() {
                    window.setTimeout("siteTime()", 1000);
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2019";
                    var startMonth = "10";
                    var startDate = "30";
                    var startHour = "22";
                    var startMinute = "30";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffDays + " 天 " + diffHours +
                            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffYears + " 年 " + diffDays +
                            " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link ">
    <a href="https://github.com/asxing" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:asxingking@gmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>













    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    

    

    

    

    

    
    <script type="text/javascript" src="/libs/background/ribbon-dynamic.js" async="async"></script>
    
    
    

</body>

</html>
